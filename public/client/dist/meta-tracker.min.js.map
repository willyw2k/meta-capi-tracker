{
  "version": 3,
  "sources": ["../src/index.ts", "../src/state.ts", "../src/utils.ts", "../src/ad-block-recovery.ts", "../src/transport.ts", "../src/cookie-keeper.ts", "../src/pixel-router.ts", "../src/advanced-matching.ts", "../src/browser-pixel.ts", "../src/gtm.ts"],
  "sourcesContent": ["/**\n * Meta CAPI Tracker \u2014 Client-Side Library v3.0 (TypeScript)\n * ==========================================================\n *\n * Usage:\n *   MetaTracker.init({\n *     endpoint: 'https://your-server.com/api/v1/track',\n *     apiKey: 'your-api-key',\n *     pixelId: '123456789',\n *   });\n */\n\nimport {\n  VERSION, MAX_QUEUE_SIZE, BATCH_INTERVAL,\n  config, queue, batchTimer, initialized,\n  transportMethod, adBlockDetected,\n  mergeConfig, setInitialized, setBatchTimer,\n  log, warn,\n} from './state';\nimport { generateEventId, saveToStorage, removeFromStorage } from './utils';\nimport { transportSend, resolveEndpoint } from './transport';\nimport { CookieKeeper } from './cookie-keeper';\nimport { AdBlockRecovery } from './ad-block-recovery';\nimport { PixelRouter } from './pixel-router';\nimport { AdvancedMatching } from './advanced-matching';\nimport { BrowserPixel } from './browser-pixel';\nimport { GtmIntegration } from './gtm';\nimport type {\n  TrackerInitOptions, MetaEventName, CustomData, RawUserData,\n  TrackOptions, TrackingEvent, MetaTrackerAPI, CaptureSource,\n  MatchQualityResult, DebugInfo, HashedUserData,\n} from './types';\n\n// \u2500\u2500 Core Queue \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nasync function sendEvents(events: TrackingEvent[]): Promise<void> {\n  if (!events.length) return;\n  const url = events.length === 1 ? resolveEndpoint('/event') : resolveEndpoint('/batch');\n  const body = events.length === 1 ? events[0] : { events };\n  try { await transportSend(url, body); } catch (e) { warn('Send failed:', e); }\n}\n\nfunction flushQueue(): void {\n  if (!queue.length) return;\n  sendEvents(queue.splice(0, MAX_QUEUE_SIZE));\n}\n\nfunction enqueueEvent(event: TrackingEvent): void {\n  queue.push(event);\n  if (config.batchEvents) {\n    if (batchTimer) clearTimeout(batchTimer);\n    setBatchTimer(setTimeout(flushQueue, BATCH_INTERVAL));\n  } else { flushQueue(); }\n}\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// \u2500\u2500 PUBLIC API\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\nconst MetaTracker: MetaTrackerAPI = {\n  VERSION,\n\n  async init(options: TrackerInitOptions): Promise<MetaTrackerAPI> {\n    if (initialized) { warn('Already initialized'); return this; }\n    if (!options.endpoint || !options.apiKey) { warn('Missing: endpoint, apiKey'); return this; }\n    if (!('pixelId' in options && options.pixelId) && !('pixels' in options && options.pixels?.length)) {\n      warn('Missing: pixelId or pixels[]'); return this;\n    }\n    if (options.respectDnt && (navigator.doNotTrack === '1' || window.doNotTrack === '1')) return this;\n\n    mergeConfig(options);\n    setInitialized(true);\n    log('Initialized v' + VERSION);\n\n    CookieKeeper.init();\n    AdvancedMatching.init();\n    BrowserPixel.init();\n    GtmIntegration.init();\n\n    if (config.adBlockRecovery.enabled) {\n      AdBlockRecovery.detect().then((blocked: boolean) => { if (blocked) log('Ad blocker recovery: ACTIVE'); });\n    }\n\n    if (config.autoPageView) this.trackPageView();\n\n    window.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden') flushQueue(); });\n    window.addEventListener('beforeunload', flushQueue);\n    return this;\n  },\n\n  async track(\n    eventName: MetaEventName, customData: CustomData = {},\n    userData: RawUserData = {}, options: TrackOptions = {},\n  ): Promise<string | undefined> {\n    if (!initialized) { warn('Not initialized'); return undefined; }\n\n    const eventId = options.event_id ?? generateEventId();\n\n    const enrichedUserData: HashedUserData = config.advancedMatching.enabled\n      ? await AdvancedMatching.buildUserData(userData)\n      : await AdvancedMatching.normalizeAndHash(userData);\n\n    const matchScore = AdvancedMatching.scoreMatchQuality(enrichedUserData);\n    log(`Match quality: ${matchScore}/100`);\n\n    if (matchScore < config.minMatchQuality) {\n      warn(`Match quality ${matchScore} below threshold ${config.minMatchQuality}, skipping event`);\n      return undefined;\n    }\n\n    const pixelIds = options.pixel_id ? [options.pixel_id] : PixelRouter.resolve();\n    if (!pixelIds.length) { warn('No pixel for:', window.location.hostname); return undefined; }\n\n    for (const pixelId of pixelIds) {\n      const event: TrackingEvent = {\n        pixel_id: pixelId,\n        event_name: eventName,\n        event_id: pixelIds.length > 1 ? `${eventId}_${pixelId.slice(-4)}` : eventId,\n        event_time: Math.floor(Date.now() / 1000),\n        event_source_url: window.location.href,\n        action_source: options.action_source ?? 'website',\n        user_data: { ...enrichedUserData },\n        match_quality: matchScore,\n        visitor_id: CookieKeeper.getVisitorId() ?? null,\n      };\n      if (Object.keys(customData).length) event.custom_data = customData;\n      log('Track:', eventName, '\u2192', pixelId, `(match: ${matchScore})`);\n      enqueueEvent(event);\n      BrowserPixel.trackEvent(eventName, event.event_id, customData);\n    }\n\n    GtmIntegration.notifyDataLayer(eventName, eventId, customData);\n\n    return eventId;\n  },\n\n  // \u2500\u2500 Convenience methods \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  trackPageView(ud: RawUserData = {}) { return this.track('PageView', {}, ud); },\n  trackViewContent(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('ViewContent', cd, ud); },\n  trackAddToCart(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('AddToCart', cd, ud); },\n  trackPurchase(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('Purchase', cd, ud); },\n  trackLead(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('Lead', cd, ud); },\n  trackCompleteRegistration(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('CompleteRegistration', cd, ud); },\n  trackInitiateCheckout(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('InitiateCheckout', cd, ud); },\n  trackSearch(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('Search', cd, ud); },\n  trackAddToWishlist(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('AddToWishlist', cd, ud); },\n  trackAddPaymentInfo(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('AddPaymentInfo', cd, ud); },\n  trackContact(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('Contact', cd, ud); },\n  trackCustomizeProduct(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('CustomizeProduct', cd, ud); },\n  trackDonate(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('Donate', cd, ud); },\n  trackFindLocation(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('FindLocation', cd, ud); },\n  trackSchedule(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('Schedule', cd, ud); },\n  trackStartTrial(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('StartTrial', cd, ud); },\n  trackSubmitApplication(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('SubmitApplication', cd, ud); },\n  trackSubscribe(cd: CustomData = {}, ud: RawUserData = {}) { return this.track('Subscribe', cd, ud); },\n  trackToPixel(pixelId: string, name: MetaEventName, cd: CustomData = {}, ud: RawUserData = {}) {\n    return this.track(name, cd, ud, { pixel_id: pixelId });\n  },\n\n  // \u2500\u2500 Identity \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  async identify(userData: RawUserData = {}): Promise<void> {\n    if (!initialized) { warn('Not initialized'); return; }\n\n    const normalized: Record<string, string> = {};\n    for (const [key, value] of Object.entries(userData)) {\n      if (!value) continue;\n      normalized[AdvancedMatching.aliasMap[key] ?? key] = value;\n    }\n\n    const hashed = await AdvancedMatching.normalizeAndHash(normalized as RawUserData);\n\n    for (const [field, storageKey] of Object.entries(AdvancedMatching.storageMap)) {\n      const val = (hashed as Record<string, string | undefined>)[field];\n      if (val && storageKey) saveToStorage(storageKey, val, config.cookieKeeper.maxAge);\n    }\n\n    AdvancedMatching._mergeCapture('identify', normalized as RawUserData);\n    log('Identify:', Object.keys(hashed).filter(\n      (k) => (hashed as Record<string, unknown>)[k] && !['client_user_agent', 'fbp', 'fbc'].includes(k),\n    ));\n    CookieKeeper.syncToServer();\n  },\n\n  clearIdentity(): void {\n    ['_mt_em', '_mt_ph', '_mt_fn', '_mt_ln', '_mt_eid', '_mt_ct', '_mt_st', '_mt_zp', '_mt_country']\n      .forEach(removeFromStorage);\n    AdvancedMatching.resetCapturedData();\n    log('Identity cleared');\n  },\n\n  // \u2500\u2500 Multi-domain \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  addPixel(pixelId: string, domains: string | string[]): void {\n    config.pixels.push({ pixelId, domains: Array.isArray(domains) ? domains : [domains] });\n  },\n  removePixel(pixelId: string): void {\n    config.pixels = config.pixels.filter((p) => p.pixelId !== pixelId);\n  },\n\n  // \u2500\u2500 Cookie Keeper \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  refreshCookies(): void { CookieKeeper.refreshCookies(); },\n\n  // \u2500\u2500 Diagnostics \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  flush(): void { flushQueue(); },\n  isAdBlocked(): boolean { return adBlockDetected; },\n  getTransport(): string { return transportMethod; },\n\n  getDebugInfo(): DebugInfo {\n    return {\n      version: VERSION, initialized, transport: transportMethod, adBlockDetected,\n      config: { endpoint: config.endpoint, pixelId: config.pixelId, pixelCount: config.pixels.length },\n      cookies: { fbp: CookieKeeper.getFbp(), fbc: CookieKeeper.getFbc(), visitorId: CookieKeeper.getVisitorId() },\n      routing: { domain: window.location.hostname, active: PixelRouter.resolve(), all: PixelRouter.getAllPixelIds() },\n      advancedMatching: AdvancedMatching.getDiagnostics(),\n      queueSize: queue.length,\n    };\n  },\n\n  async getMatchQuality(extraUserData: RawUserData = {}): Promise<MatchQualityResult> {\n    const ud = config.advancedMatching.enabled\n      ? await AdvancedMatching.buildUserData(extraUserData)\n      : await AdvancedMatching.normalizeAndHash(extraUserData);\n    return {\n      score: AdvancedMatching.scoreMatchQuality(ud),\n      fields: Object.keys(ud).filter((k) => (ud as Record<string, unknown>)[k]),\n    };\n  },\n\n  addUserData(data: RawUserData, source: CaptureSource = 'explicit'): void {\n    AdvancedMatching._mergeCapture(source, data);\n  },\n\n  // \u2500\u2500 GTM Integration \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  pushToDataLayer(event: string, data: Record<string, unknown> = {}): void {\n    GtmIntegration.pushToDataLayer(event, data);\n  },\n};\n\n// \u2500\u2500 Expose globally \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nwindow.MetaTracker = MetaTracker;\n\nif (window.MetaTrackerQueue && Array.isArray(window.MetaTrackerQueue)) {\n  for (const [method, ...args] of window.MetaTrackerQueue) {\n    const fn = (MetaTracker as unknown as Record<string, (...a: unknown[]) => unknown>)[method];\n    if (typeof fn === 'function') fn.apply(MetaTracker, args);\n  }\n}\n\nexport { MetaTracker };\nexport default MetaTracker;\n\n// Re-export types for consumers\nexport type {\n  TrackerConfig, TrackerInitOptions, MetaEventName, MetaStandardEvent,\n  CustomData, RawUserData, HashedUserData, TrackOptions, TrackingEvent,\n  MetaTrackerAPI, PixelConfig, CookieKeeperConfig, AdBlockRecoveryConfig,\n  AdvancedMatchingConfig, BrowserPixelConfig, GtmConfig,\n  CaptureSource, MatchQualityResult, DebugInfo,\n} from './types';\n", "/**\n * Shared mutable state \u2014 centralised to avoid circular imports.\n */\nimport type { TrackerConfig, TrackingEvent } from './types';\n\nexport const VERSION = '2.1.0';\nexport const MAX_QUEUE_SIZE = 50;\nexport const RETRY_DELAYS: readonly number[] = [1000, 5000, 15000];\nexport const BATCH_INTERVAL = 2000;\n\nexport let config: TrackerConfig = {\n  endpoint: '', apiKey: '', pixelId: '', pixels: [],\n  autoPageView: true, debug: false, hashPii: true,\n  respectDnt: false, batchEvents: true, minMatchQuality: 60,\n  browserPixel: { enabled: false, autoPageView: true, syncEvents: true },\n  cookieKeeper: { enabled: true, refreshInterval: 86_400_000, maxAge: 180, cookieNames: ['_fbp', '_fbc', '_mt_id'] },\n  adBlockRecovery: { enabled: true, proxyPath: '/collect', useBeacon: true, useImage: true, customEndpoints: [] },\n  advancedMatching: {\n    enabled: true, autoCaptureForms: true, captureUrlParams: true,\n    captureDataLayer: true, captureMetaTags: true, autoIdentifyOnSubmit: true,\n    formFieldMap: {}, dataLayerKey: 'dataLayer', userDataKey: null,\n  },\n  gtm: {\n    enabled: false, autoMapEcommerce: true, pushToDataLayer: true,\n    dataLayerKey: 'dataLayer', eventMapping: {},\n  },\n};\n\nexport const queue: TrackingEvent[] = [];\nexport let batchTimer: ReturnType<typeof setTimeout> | null = null;\nexport let initialized = false;\nexport let transportMethod = 'fetch';\nexport let adBlockDetected = false;\nexport let cookieKeeperTimer: ReturnType<typeof setInterval> | null = null;\n\n// Setters (ES module exported `let` bindings are read-only from outside)\nexport function mergeConfig(opts: Partial<TrackerConfig>): void {\n  Object.assign(config, opts, {\n    browserPixel: { ...config.browserPixel, ...((opts.browserPixel as object) ?? {}) },\n    cookieKeeper: { ...config.cookieKeeper, ...((opts.cookieKeeper as object) ?? {}) },\n    adBlockRecovery: { ...config.adBlockRecovery, ...((opts.adBlockRecovery as object) ?? {}) },\n    advancedMatching: { ...config.advancedMatching, ...((opts.advancedMatching as object) ?? {}) },\n    gtm: { ...config.gtm, ...((opts.gtm as object) ?? {}) },\n  });\n}\nexport function setInitialized(v: boolean): void { initialized = v; }\nexport function setTransportMethod(v: string): void { transportMethod = v; }\nexport function setAdBlockDetected(v: boolean): void { adBlockDetected = v; }\nexport function setBatchTimer(v: ReturnType<typeof setTimeout> | null): void { batchTimer = v; }\nexport function setCookieKeeperTimer(v: ReturnType<typeof setInterval> | null): void { cookieKeeperTimer = v; }\n\n// Logging\nexport function spliceQueue(count: number): TrackingEvent[] { return queue.splice(0, count); }\nexport function pushQueue(event: TrackingEvent): void { queue.push(event); }\nexport function log(...args: unknown[]): void { if (config.debug) console.log('[MetaTracker]', ...args); }\nexport function warn(...args: unknown[]): void { if (config.debug) console.warn('[MetaTracker]', ...args); }\n", "/**\n * Utility helpers \u2014 storage, hashing, ID generation.\n */\nimport { config } from './state';\n\nexport async function sha256(value: string): Promise<string | null> {\n  if (!value) return null;\n  const data = new TextEncoder().encode(value.toString().trim().toLowerCase());\n  const hash = await crypto.subtle.digest('SHA-256', data);\n  return Array.from(new Uint8Array(hash)).map((b) => b.toString(16).padStart(2, '0')).join('');\n}\n\nexport function isHashed(value: unknown): value is string {\n  return typeof value === 'string' && /^[a-f0-9]{64}$/.test(value);\n}\n\nexport function generateEventId(): string {\n  return `evt_${Date.now().toString(36)}_${Math.random().toString(36).substring(2, 10)}`;\n}\n\nexport function generateVisitorId(): string {\n  const stored = getFromStorage('_mt_id');\n  if (stored) return stored;\n  const id = 'mt.' + Date.now().toString(36) + '.' + Math.random().toString(36).substring(2, 12);\n  saveToStorage('_mt_id', id);\n  return id;\n}\n\nfunction getRootDomain(): string {\n  try {\n    const parts = window.location.hostname.split('.');\n    if (parts.length <= 1 || /^\\d+$/.test(parts[parts.length - 1])) return '';\n    return parts.slice(-2).join('.');\n  } catch { return ''; }\n}\n\nexport function setCookie(name: string, value: string, days: number): void {\n  const maxAge = days * 86_400;\n  const secure = location.protocol === 'https:' ? '; Secure' : '';\n  const domain = getRootDomain();\n  const domainStr = domain ? `; domain=.${domain}` : '';\n  document.cookie = `${name}=${encodeURIComponent(value)}; path=/${domainStr}; max-age=${maxAge}; SameSite=Lax${secure}`;\n}\n\nexport function getCookie(name: string): string | null {\n  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));\n  return match ? decodeURIComponent(match[2]) : null;\n}\n\nexport function deleteCookie(name: string): void {\n  const domain = getRootDomain();\n  document.cookie = `${name}=; path=/${domain ? `; domain=.${domain}` : ''}; max-age=0`;\n}\n\nexport function getFromStorage(key: string): string | null {\n  const c = getCookie(key);\n  if (c) return c;\n  try { return localStorage.getItem('mt_' + key); } catch { return null; }\n}\n\nexport function saveToStorage(key: string, value: string, days?: number): void {\n  days = days ?? (config.cookieKeeper.maxAge || 180);\n  setCookie(key, value, days);\n  try { localStorage.setItem('mt_' + key, value); } catch { /* noop */ }\n}\n\nexport function removeFromStorage(key: string): void {\n  deleteCookie(key);\n  try { localStorage.removeItem('mt_' + key); } catch { /* noop */ }\n}\n", "/**\n * Ad Blocker Recovery \u2014 detection, disguised endpoints, payload obfuscation.\n */\nimport { config, adBlockDetected, setAdBlockDetected, log, VERSION } from './state';\nimport type { DisguisedPayload } from './types';\n\nexport const AdBlockRecovery = {\n  async detect(): Promise<boolean> {\n    if (!config.adBlockRecovery.enabled) return false;\n    try {\n      const testUrl = config.endpoint.replace(/\\/track\\/?$/, '') + '/health';\n      const ctrl = new AbortController();\n      const t = setTimeout(() => ctrl.abort(), 3000);\n      const r = await fetch(testUrl, { method: 'GET', signal: ctrl.signal, cache: 'no-store' });\n      clearTimeout(t);\n      if (!r.ok) throw new Error('Blocked');\n      return false;\n    } catch {\n      setAdBlockDetected(true);\n      log('AdBlockRecovery: DETECTED');\n      return true;\n    }\n  },\n\n  getEndpoint(path: string): string {\n    if (adBlockDetected && config.adBlockRecovery.proxyPath) {\n      return config.endpoint.replace(/\\/api\\/v1\\/track\\/?$/, '') + config.adBlockRecovery.proxyPath + path;\n    }\n    return config.endpoint + path;\n  },\n\n  getFallbackEndpoints(path: string): string[] {\n    const eps = [this.getEndpoint(path)];\n    for (const ep of config.adBlockRecovery.customEndpoints ?? []) eps.push(ep + path);\n    return eps;\n  },\n\n  disguisePayload(data: unknown): DisguisedPayload | unknown {\n    if (!adBlockDetected) return data;\n    return { d: btoa(JSON.stringify(data)), t: Date.now(), v: VERSION };\n  },\n\n  getHeaders(): Record<string, string> {\n    const h: Record<string, string> = { 'Content-Type': 'application/json' };\n    h[adBlockDetected ? 'X-Request-Token' : 'X-API-Key'] = config.apiKey;\n    return h;\n  },\n};\n", "/**\n * Transport Layer \u2014 fetch \u2192 beacon \u2192 XHR \u2192 image fallback chain.\n */\nimport { AdBlockRecovery } from './ad-block-recovery';\nimport {\n  config, adBlockDetected, transportMethod, setTransportMethod,\n  log, warn, RETRY_DELAYS,\n} from './state';\nimport type { TransportDef } from './types';\n\nexport function resolveEndpoint(path: string): string {\n  return adBlockDetected ? AdBlockRecovery.getEndpoint(path) : config.endpoint + path;\n}\n\nasync function viaFetch(url: string, data: unknown): Promise<unknown> {\n  const body = adBlockDetected ? AdBlockRecovery.disguisePayload(data) : data;\n  const r = await fetch(url, {\n    method: 'POST', headers: AdBlockRecovery.getHeaders(),\n    body: JSON.stringify(body), keepalive: true, credentials: 'include',\n  });\n  if (!r.ok) throw new Error(`HTTP ${r.status}`);\n  return r.json().catch(() => ({}));\n}\n\nfunction viaBeacon(url: string, data: unknown): Promise<unknown> {\n  const body = adBlockDetected ? AdBlockRecovery.disguisePayload(data) : data;\n  const blob = new Blob([JSON.stringify(body)], { type: 'application/json' });\n  if (!navigator.sendBeacon(url + '?api_key=' + encodeURIComponent(config.apiKey), blob)) {\n    throw new Error('Beacon failed');\n  }\n  return Promise.resolve({ sent: true });\n}\n\nfunction viaXhr(url: string, data: unknown): Promise<unknown> {\n  return new Promise((resolve, reject) => {\n    const xhr = new XMLHttpRequest();\n    xhr.open('POST', url, true);\n    for (const [k, v] of Object.entries(AdBlockRecovery.getHeaders())) xhr.setRequestHeader(k, v);\n    xhr.withCredentials = true;\n    xhr.timeout = 10_000;\n    xhr.onload = () => xhr.status >= 200 && xhr.status < 300\n      ? resolve(JSON.parse(xhr.responseText || '{}'))\n      : reject(new Error(`XHR ${xhr.status}`));\n    xhr.onerror = () => reject(new Error('XHR error'));\n    xhr.ontimeout = () => reject(new Error('XHR timeout'));\n    const body = adBlockDetected ? AdBlockRecovery.disguisePayload(data) : data;\n    xhr.send(JSON.stringify(body));\n  });\n}\n\nfunction viaImage(url: string, data: unknown): Promise<unknown> {\n  return new Promise((resolve, reject) => {\n    const params = new URLSearchParams({ d: btoa(JSON.stringify(data)), k: config.apiKey, t: Date.now().toString() });\n    const imgUrl = url.replace(/\\/(event|batch)$/, '/pixel.gif') + '?' + params;\n    if (imgUrl.length > 4000) { reject(new Error('Payload too large')); return; }\n    const img = new Image(1, 1);\n    img.onload = () => resolve({ sent: true });\n    img.onerror = () => reject(new Error('Image pixel failed'));\n    img.src = imgUrl;\n  });\n}\n\nexport async function transportSend(url: string, data: unknown, attempt = 0): Promise<unknown> {\n  const transports: TransportDef[] = [\n    { name: 'fetch', fn: viaFetch },\n    { name: 'beacon', fn: viaBeacon, skip: !config.adBlockRecovery.useBeacon },\n    { name: 'xhr', fn: viaXhr },\n    { name: 'img', fn: viaImage, skip: !config.adBlockRecovery.useImage },\n  ].filter((t) => !t.skip);\n\n  for (const transport of transports) {\n    const pathSuffix = url.includes(config.endpoint)\n      ? url.replace(config.endpoint, '')\n      : url.replace(/^https?:\\/\\/[^/]+/, '').replace(/.*\\/api\\/v1\\/track/, '');\n    const endpoints = adBlockDetected ? AdBlockRecovery.getFallbackEndpoints(pathSuffix) : [url];\n\n    for (const ep of endpoints) {\n      try {\n        const result = await transport.fn(ep, data);\n        if (transport.name !== transportMethod) {\n          log(`Transport: ${transportMethod} \u2192 ${transport.name}`);\n          setTransportMethod(transport.name);\n        }\n        return result;\n      } catch (e: unknown) { log(`${transport.name} \u2192 ${ep}: ${(e as Error).message}`); }\n    }\n  }\n\n  if (attempt < RETRY_DELAYS.length) {\n    return new Promise((r) => setTimeout(() => r(transportSend(url, data, attempt + 1)), RETRY_DELAYS[attempt]));\n  }\n  warn('All transports exhausted');\n  return undefined;\n}\n", "/**\n * Cookie Keeper \u2014 ITP survival via server-side cookie renewal.\n */\nimport { config, log, warn, cookieKeeperTimer, setCookieKeeperTimer } from './state';\nimport { getCookie, setCookie, getFromStorage, saveToStorage, generateVisitorId } from './utils';\nimport { transportSend, resolveEndpoint } from './transport';\n\nexport const CookieKeeper = {\n  init(): void {\n    if (!config.cookieKeeper.enabled) return;\n    this.restoreCookies(); this.captureFbclid(); this.ensureFbp();\n    this.ensureVisitorId(); this.syncToServer(); this.scheduleRefresh();\n    log('CookieKeeper: ready', { fbp: this.getFbp(), fbc: this.getFbc() });\n  },\n\n  restoreCookies(): void {\n    for (const name of config.cookieKeeper.cookieNames ?? []) {\n      if (!getCookie(name)) {\n        try { const b = localStorage.getItem('mt_' + name); if (b) setCookie(name, b, config.cookieKeeper.maxAge); } catch { /* */ }\n      } else {\n        try { localStorage.setItem('mt_' + name, getCookie(name)!); } catch { /* */ }\n      }\n    }\n  },\n\n  captureFbclid(): void {\n    try {\n      const fbclid = new URL(window.location.href).searchParams.get('fbclid');\n      if (fbclid) saveToStorage('_fbc', `fb.1.${Math.floor(Date.now() / 1000)}.${fbclid}`, config.cookieKeeper.maxAge);\n    } catch { /* */ }\n  },\n\n  ensureFbp(): void {\n    if (!getFromStorage('_fbp')) {\n      saveToStorage('_fbp', `fb.1.${Date.now()}.${Math.floor(Math.random() * 2_147_483_647)}`, config.cookieKeeper.maxAge);\n    }\n  },\n\n  ensureVisitorId(): void { if (!getFromStorage('_mt_id')) generateVisitorId(); },\n\n  async syncToServer(): Promise<void> {\n    const cookies: Record<string, string | null> = {\n      _fbp: getFromStorage('_fbp'), _fbc: getFromStorage('_fbc'),\n      _mt_id: getFromStorage('_mt_id'), _mt_em: getFromStorage('_mt_em'), _mt_ph: getFromStorage('_mt_ph'),\n    };\n    if (!cookies._fbp && !cookies._fbc && !cookies._mt_id) return;\n    const last = getFromStorage('_mt_cookie_sync');\n    if (last && Date.now() - parseInt(last, 10) < config.cookieKeeper.refreshInterval) return;\n    try {\n      await transportSend(resolveEndpoint('/cookie-sync'), { cookies, domain: window.location.hostname, max_age: config.cookieKeeper.maxAge });\n      saveToStorage('_mt_cookie_sync', Date.now().toString(), 1);\n    } catch (e: unknown) { warn('CookieKeeper: sync failed', (e as Error).message); }\n  },\n\n  refreshCookies(): void {\n    for (const name of config.cookieKeeper.cookieNames ?? []) {\n      const v = getFromStorage(name); if (v) setCookie(name, v, config.cookieKeeper.maxAge);\n    }\n    saveToStorage('_mt_cookie_sync', '0', 1);\n    this.syncToServer();\n  },\n\n  scheduleRefresh(): void {\n    if (cookieKeeperTimer) clearInterval(cookieKeeperTimer);\n    setCookieKeeperTimer(setInterval(() => this.refreshCookies(), config.cookieKeeper.refreshInterval));\n    document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') this.restoreCookies(); });\n  },\n\n  getFbp(): string | null { return getFromStorage('_fbp'); },\n  getFbc(): string | null { return getFromStorage('_fbc'); },\n  getVisitorId(): string | null { return getFromStorage('_mt_id'); },\n};\n", "/**\n * Pixel Router \u2014 multi-domain pixel ID resolution.\n */\nimport { config } from './state';\n\nexport const PixelRouter = {\n  resolve(hostname?: string): string[] {\n    hostname = hostname ?? window.location.hostname;\n    if (!config.pixels?.length) return config.pixelId ? [config.pixelId] : [];\n    const matched: string[] = [];\n    let catchAll: string | null = null;\n    for (const pc of config.pixels) {\n      if (!pc.pixelId || !pc.domains) continue;\n      for (const pattern of pc.domains) {\n        if (pattern === '*') { catchAll = pc.pixelId; continue; }\n        if (this.matchDomain(hostname, pattern)) { matched.push(pc.pixelId); break; }\n      }\n    }\n    if (!matched.length && catchAll) matched.push(catchAll);\n    return [...new Set(matched)];\n  },\n\n  matchDomain(hostname: string, pattern: string): boolean {\n    if (hostname === pattern) return true;\n    if (pattern.startsWith('*.')) {\n      const suffix = pattern.substring(2);\n      return hostname.endsWith('.' + suffix) || hostname === suffix;\n    }\n    return hostname.endsWith('.' + pattern);\n  },\n\n  getAllPixelIds(): string[] {\n    if (!config.pixels?.length) return config.pixelId ? [config.pixelId] : [];\n    return [...new Set(config.pixels.map((p) => p.pixelId).filter(Boolean))];\n  },\n};\n", "/**\n * Advanced Matching \u2014 PII capture, normalisation, hashing, identity graph.\n *\n * Data sources (priority order):\n *   1. Explicit userData \u2192 track()\n *   2. identify() stored identity\n *   3. Auto-captured form data\n *   4. URL parameters\n *   5. DataLayer / GTM\n *   6. Meta tags / structured data\n */\n\nimport { config, log } from './state';\nimport { sha256, isHashed, getFromStorage } from './utils';\nimport { CookieKeeper } from './cookie-keeper';\nimport type {\n  MetaPiiField, CaptureSource, CapturedData,\n  HashedUserData, RawUserData, FieldPatterns, Normalizer,\n  AdvancedMatchingDiagnostics,\n} from './types';\n\n// \u2500\u2500 Module state \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nlet capturedData: CapturedData = {};\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// \u2500\u2500 NORMALIZERS (per Meta docs)\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\nconst normalizers: Record<string, Normalizer> = {\n  em(v) {\n    if (!v) return null;\n    v = v.trim().toLowerCase();\n    return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(v) ? v : null;\n  },\n  ph(v) {\n    if (!v) return null;\n    let d = v.replace(/\\D/g, '');\n    if (d.length < 7) return null;\n    if (d.startsWith('00')) d = d.substring(2);\n    return d || null;\n  },\n  fn(v) {\n    if (!v) return null;\n    v = v.trim().toLowerCase().replace(/^(mr|mrs|ms|miss|dr|prof)\\.?\\s*/i, '');\n    v = v.replace(/[^a-z\\s\\u00C0-\\u024F]/g, '');\n    try { v = v.normalize('NFD').replace(/[\\u0300-\\u036f]/g, ''); } catch { /* */ }\n    return v.trim() || null;\n  },\n  ln(v) { return normalizers.fn(v); },\n  ge(v) {\n    if (!v) return null;\n    v = v.trim().toLowerCase();\n    if (v.startsWith('m') || v === 'male') return 'm';\n    if (v.startsWith('f') || v === 'female') return 'f';\n    return null;\n  },\n  db(v) {\n    if (!v) return null;\n    v = v.trim();\n    if (/^\\d{8}$/.test(v)) return v;\n    const fmts: RegExp[] = [/^(\\d{4})-(\\d{2})-(\\d{2})$/, /^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/, /^(\\d{2})-(\\d{2})-(\\d{4})$/];\n    for (const rx of fmts) {\n      const m = v.match(rx);\n      if (m) return m[1].length === 4 ? m[1] + m[2] + m[3] : m[3] + m[1] + m[2];\n    }\n    return null;\n  },\n  ct(v) {\n    if (!v) return null;\n    v = v.trim().toLowerCase().replace(/[^a-z\\s\\u00C0-\\u024F]/g, '');\n    try { v = v.normalize('NFD').replace(/[\\u0300-\\u036f]/g, ''); } catch { /* */ }\n    return v.trim() || null;\n  },\n  st(v) {\n    if (!v) return null;\n    v = v.trim().toLowerCase();\n    if (/^[a-z]{2}$/.test(v)) return v;\n    const m = v.match(/\\b([a-z]{2})\\b/);\n    return m ? m[1] : v.substring(0, 2);\n  },\n  zp(v) {\n    if (!v) return null;\n    v = v.trim().toLowerCase().replace(/\\s+/g, '');\n    if (/^\\d{5}(-\\d{4})?$/.test(v)) return v.substring(0, 5);\n    return v || null;\n  },\n  country(v) {\n    if (!v) return null;\n    v = v.trim().toLowerCase();\n    if (/^[a-z]{2}$/.test(v)) return v;\n    const map: Record<string, string> = {\n      'united states': 'us', 'usa': 'us', 'united kingdom': 'gb', 'uk': 'gb',\n      'canada': 'ca', 'australia': 'au', 'germany': 'de', 'france': 'fr',\n      'indonesia': 'id', 'japan': 'jp', 'india': 'in', 'brazil': 'br',\n      'mexico': 'mx', 'spain': 'es', 'italy': 'it', 'netherlands': 'nl',\n      'singapore': 'sg', 'malaysia': 'my', 'philippines': 'ph', 'thailand': 'th',\n      'vietnam': 'vn', 'south korea': 'kr', 'china': 'cn', 'taiwan': 'tw',\n      'hong kong': 'hk', 'new zealand': 'nz', 'portugal': 'pt', 'sweden': 'se',\n      'norway': 'no', 'denmark': 'dk', 'finland': 'fi', 'poland': 'pl',\n      'cambodia': 'kh', 'turkey': 'tr', 'argentina': 'ar', 'colombia': 'co',\n      'chile': 'cl', 'peru': 'pe', 'south africa': 'za', 'nigeria': 'ng',\n      'egypt': 'eg', 'saudi arabia': 'sa', 'united arab emirates': 'ae', 'uae': 'ae',\n      'russia': 'ru', 'ukraine': 'ua', 'ireland': 'ie', 'switzerland': 'ch',\n      'austria': 'at', 'belgium': 'be', 'czech republic': 'cz', 'romania': 'ro',\n    };\n    return map[v] ?? (v.length === 2 ? v : null);\n  },\n  external_id(v) { return v?.trim() || null; },\n};\n\n// \u2500\u2500 Field detection patterns \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nconst fieldPatterns: Record<string, FieldPatterns> = {\n  em: {\n    types: ['email'],\n    names: ['email', 'e-mail', 'user_email', 'userEmail', 'customer_email', 'login', 'username', 'emailAddress', 'email_address'],\n    ids: ['email', 'user-email', 'customer-email', 'signup-email', 'login-email'],\n    autocomplete: ['email'],\n    placeholders: ['email', 'e-mail', 'your email', 'email address'],\n  },\n  ph: {\n    types: ['tel'],\n    names: ['phone', 'telephone', 'tel', 'mobile', 'phone_number', 'phoneNumber', 'cell', 'cellphone', 'mobile_number', 'contact_number', 'whatsapp'],\n    ids: ['phone', 'telephone', 'mobile', 'phone-number'],\n    autocomplete: ['tel', 'tel-national', 'tel-local'],\n    placeholders: ['phone', 'telephone', 'mobile', 'whatsapp', 'nomor telepon', 'hp'],\n  },\n  fn: {\n    names: ['first_name', 'firstName', 'fname', 'given-name', 'givenName', 'first', 'name_first', 'billing_first_name'],\n    ids: ['first-name', 'firstname', 'fname', 'given-name'],\n    autocomplete: ['given-name'],\n    placeholders: ['first name', 'given name', 'nama depan'],\n  },\n  ln: {\n    names: ['last_name', 'lastName', 'lname', 'family-name', 'familyName', 'surname', 'last', 'name_last', 'billing_last_name'],\n    ids: ['last-name', 'lastname', 'lname', 'family-name', 'surname'],\n    autocomplete: ['family-name'],\n    placeholders: ['last name', 'family name', 'surname', 'nama belakang'],\n  },\n  ct: {\n    names: ['city', 'town', 'billing_city', 'shipping_city', 'address_city'],\n    ids: ['city', 'billing-city', 'shipping-city'],\n    autocomplete: ['address-level2'],\n    placeholders: ['city', 'town', 'kota'],\n  },\n  st: {\n    names: ['state', 'province', 'region', 'billing_state', 'shipping_state'],\n    ids: ['state', 'province', 'region', 'billing-state'],\n    autocomplete: ['address-level1'],\n    placeholders: ['state', 'province', 'region', 'provinsi'],\n  },\n  zp: {\n    names: ['zip', 'zipcode', 'zip_code', 'postal', 'postal_code', 'postcode', 'billing_zip', 'billing_postcode', 'shipping_zip'],\n    ids: ['zip', 'zipcode', 'postal-code', 'postcode'],\n    autocomplete: ['postal-code'],\n    placeholders: ['zip', 'postal code', 'zip code', 'kode pos'],\n  },\n  country: {\n    names: ['country', 'country_code', 'countryCode', 'billing_country', 'shipping_country'],\n    ids: ['country', 'billing-country', 'shipping-country'],\n    autocomplete: ['country', 'country-name'],\n    placeholders: ['country', 'negara'],\n  },\n  ge: { names: ['gender', 'sex'], ids: ['gender', 'sex'], autocomplete: ['sex'], placeholders: ['gender', 'jenis kelamin'] },\n  db: {\n    names: ['birthday', 'birthdate', 'date_of_birth', 'dob', 'dateOfBirth', 'birth_date', 'bday'],\n    ids: ['birthday', 'birthdate', 'dob', 'date-of-birth'],\n    autocomplete: ['bday'],\n    placeholders: ['birthday', 'date of birth', 'tanggal lahir'],\n  },\n};\n\n// \u2500\u2500 Source priority \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nconst sourcePriority: Record<CaptureSource, number> = {\n  explicit: 100, identify: 90, form: 80, form_prefill: 70,\n  url: 60, dataLayer: 50, customDataLayer: 50, metatag: 30,\n};\n\n// \u2500\u2500 Mapping tables \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nconst dataLayerFieldMap: Record<string, MetaPiiField> = {\n  email: 'em', em: 'em', user_email: 'em', customerEmail: 'em',\n  phone: 'ph', ph: 'ph', telephone: 'ph', mobile: 'ph', phoneNumber: 'ph',\n  first_name: 'fn', fn: 'fn', firstName: 'fn', givenName: 'fn',\n  last_name: 'ln', ln: 'ln', lastName: 'ln', familyName: 'ln', surname: 'ln',\n  gender: 'ge', ge: 'ge', sex: 'ge',\n  date_of_birth: 'db', db: 'db', birthday: 'db', dob: 'db', birthdate: 'db',\n  city: 'ct', ct: 'ct', town: 'ct',\n  state: 'st', st: 'st', province: 'st', region: 'st',\n  zip: 'zp', zp: 'zp', zipcode: 'zp', postal_code: 'zp', postcode: 'zp',\n  country: 'country', country_code: 'country', countryCode: 'country',\n  external_id: 'external_id', user_id: 'external_id', userId: 'external_id',\n  customer_id: 'external_id', customerId: 'external_id',\n};\n\nconst aliasMap: Record<string, MetaPiiField> = {\n  email: 'em', phone: 'ph', first_name: 'fn', last_name: 'ln',\n  gender: 'ge', date_of_birth: 'db', city: 'ct', state: 'st',\n  zip: 'zp', zipcode: 'zp', postal_code: 'zp',\n};\n\nconst storageMap: Partial<Record<MetaPiiField, string>> = {\n  em: '_mt_em', ph: '_mt_ph', external_id: '_mt_eid',\n  fn: '_mt_fn', ln: '_mt_ln', ct: '_mt_ct', st: '_mt_st',\n  zp: '_mt_zp', country: '_mt_country',\n};\n\n// \u2500\u2500 PII field list \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nconst PII_FIELDS: MetaPiiField[] = ['em', 'ph', 'fn', 'ln', 'ge', 'db', 'ct', 'st', 'zp', 'country', 'external_id'];\nconst NON_PII_FIELDS = ['client_ip_address', 'client_user_agent', 'fbc', 'fbp', 'subscription_id', 'fb_login_id', 'lead_id'] as const;\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// \u2500\u2500 EXPORTED MODULE\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\nexport const AdvancedMatching = {\n\n  // \u2500\u2500 Lifecycle \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  init(): void {\n    if (!config.advancedMatching.enabled) return;\n    log('AdvancedMatching: initializing');\n    if (config.advancedMatching.captureUrlParams) this.captureFromUrl();\n    if (config.advancedMatching.captureMetaTags) this.captureFromMetaTags();\n    if (config.advancedMatching.captureDataLayer) this.captureFromDataLayer();\n    if (config.advancedMatching.autoCaptureForms) this.watchForms();\n    log('AdvancedMatching: ready, captured:', Object.keys(capturedData));\n  },\n\n  // \u2500\u2500 Normalize + Hash \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  normalize(field: string, value: string): string | null {\n    if (isHashed(value)) return value;\n    const fn = normalizers[field];\n    return fn ? fn(value) : (value ? String(value).trim().toLowerCase() : null);\n  },\n\n  async normalizeAndHash(userData: RawUserData): Promise<HashedUserData> {\n    if (!userData) return {};\n    const result: HashedUserData = {};\n\n    for (const field of PII_FIELDS) {\n      const value = (userData as Record<string, string | undefined>)[field];\n      if (!value) continue;\n      if (isHashed(value)) { result[field] = value; continue; }\n      const normalized = this.normalize(field, value);\n      if (!normalized) continue;\n      result[field] = config.hashPii ? (await sha256(normalized) ?? undefined) : normalized;\n    }\n\n    for (const field of NON_PII_FIELDS) {\n      if ((userData as Record<string, string | undefined>)[field]) {\n        result[field] = (userData as Record<string, string | undefined>)[field];\n      }\n    }\n    return result;\n  },\n\n  // \u2500\u2500 Form Auto-Capture \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  detectFieldParam(input: HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement): string | null {\n    const type = (input.type || '').toLowerCase();\n    const name = (input.name || '').toLowerCase();\n    const id = (input.id || '').toLowerCase();\n    const ac = (input.autocomplete || '').toLowerCase();\n    const ph = ('placeholder' in input ? (input.placeholder || '') : '').toLowerCase();\n\n    // Custom map first\n    for (const [sel, param] of Object.entries(config.advancedMatching.formFieldMap ?? {})) {\n      try { if (input.matches(sel)) return param; } catch { /* */ }\n    }\n\n    for (const [param, p] of Object.entries(fieldPatterns)) {\n      if (p.types?.includes(type)) return param;\n      if (p.names?.some((n) => name.includes(n))) return param;\n      if (p.ids?.some((i) => id.includes(i))) return param;\n      if (p.autocomplete?.includes(ac)) return param;\n      if (p.placeholders?.some((x) => ph.includes(x))) return param;\n    }\n\n    if (['name', 'full_name', 'fullname', 'customer_name'].includes(name) ||\n        ['name', 'full-name', 'fullname'].includes(id)) return '_fullname';\n\n    return null;\n  },\n\n  scanForm(form: HTMLFormElement): RawUserData {\n    const data: Record<string, string> = {};\n    const inputs = form.querySelectorAll<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>('input, select, textarea');\n    for (const input of inputs) {\n      if (['hidden', 'password', 'submit'].includes((input as HTMLInputElement).type)) continue;\n      const value = input.value?.trim();\n      if (!value) continue;\n      const param = this.detectFieldParam(input);\n      if (!param) continue;\n      if (param === '_fullname') {\n        const parts = value.split(/\\s+/);\n        if (parts.length >= 2) { data.fn = data.fn || parts[0]; data.ln = data.ln || parts.slice(1).join(' '); }\n        else { data.fn = data.fn || value; }\n      } else { data[param] = data[param] || value; }\n    }\n    return data as RawUserData;\n  },\n\n  watchForms(): void {\n    document.addEventListener('submit', (e: Event) => {\n      const form = e.target;\n      if (!(form instanceof HTMLFormElement)) return;\n      const data = this.scanForm(form);\n      if (Object.keys(data).length) {\n        this._mergeCapture('form', data);\n        log('AdvancedMatching: form submit captured', Object.keys(data));\n        if (config.advancedMatching.autoIdentifyOnSubmit && (data.em || data.ph)) {\n          window.MetaTracker?.identify(data);\n        }\n      }\n    }, true);\n\n    document.addEventListener('change', (e: Event) => {\n      const input = e.target;\n      if (!(input instanceof HTMLInputElement) && !(input instanceof HTMLSelectElement)) return;\n      const value = input.value?.trim();\n      if (!value) return;\n      const param = this.detectFieldParam(input);\n      if (!param || param === '_fullname') return;\n      this._mergeCapture('form', { [param]: value } as RawUserData);\n      log('AdvancedMatching: field captured', param);\n    }, true);\n\n    // Scan existing forms and observe for new ones once DOM is ready\n    const startObserving = () => {\n      document.querySelectorAll<HTMLFormElement>('form').forEach((f) => {\n        const d = this.scanForm(f);\n        if (Object.keys(d).length) { this._mergeCapture('form_prefill', d); log('AdvancedMatching: pre-filled form scanned', Object.keys(d)); }\n      });\n\n      // Watch dynamic forms\n      if (typeof MutationObserver !== 'undefined' && document.body) {\n        const obs = new MutationObserver((muts) => {\n          for (const mut of muts) for (const node of mut.addedNodes) {\n            if (!(node instanceof HTMLElement)) continue;\n            const forms = node.tagName === 'FORM' ? [node as HTMLFormElement] : [...node.querySelectorAll<HTMLFormElement>('form')];\n            for (const f of forms) { const d = this.scanForm(f); if (Object.keys(d).length) this._mergeCapture('form_prefill', d); }\n          }\n        });\n        obs.observe(document.body, { childList: true, subtree: true });\n      }\n    };\n\n    // Defer if document.body isn't available yet (script in <head>)\n    if (document.body) {\n      startObserving();\n    } else {\n      document.addEventListener('DOMContentLoaded', startObserving);\n    }\n  },\n\n  // \u2500\u2500 URL Parameter Capture \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  captureFromUrl(): void {\n    try {\n      const params = new URL(window.location.href).searchParams;\n      const data: Record<string, string> = {};\n\n      for (const p of ['email', 'em', 'e', 'user_email', 'customer_email']) {\n        const v = params.get(p); if (v?.includes('@')) { data.em = v; break; }\n      }\n      for (const p of ['phone', 'ph', 'tel', 'mobile', 'whatsapp']) {\n        const v = params.get(p); if (v && v.replace(/\\D/g, '').length >= 7) { data.ph = v; break; }\n      }\n      const fn = params.get('first_name') ?? params.get('fn'); if (fn) data.fn = fn;\n      const ln = params.get('last_name') ?? params.get('ln'); if (ln) data.ln = ln;\n      for (const p of ['external_id', 'eid', 'user_id', 'uid', 'customer_id', 'player_id']) {\n        const v = params.get(p); if (v) { data.external_id = v; break; }\n      }\n      const cc = params.get('country') ?? params.get('cc'); if (cc) data.country = cc;\n\n      if (Object.keys(data).length) { this._mergeCapture('url', data as RawUserData); log('AdvancedMatching: URL params captured', Object.keys(data)); }\n    } catch { /* */ }\n  },\n\n  // \u2500\u2500 DataLayer Capture \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  captureFromDataLayer(): void {\n    const dlKey = config.advancedMatching.dataLayerKey || 'dataLayer';\n    const dl = window[dlKey] as unknown[] | undefined;\n\n    if (Array.isArray(dl)) {\n      for (const entry of dl) this._extractFromDataLayerEntry(entry);\n      const origPush = dl.push.bind(dl);\n      dl.push = (...args: unknown[]): number => {\n        const r = origPush(...args);\n        for (const entry of args) this._extractFromDataLayerEntry(entry);\n        return r;\n      };\n    }\n\n    const udk = config.advancedMatching.userDataKey;\n    if (udk && window[udk]) this._extractUserObject(window[udk] as Record<string, unknown>, 'customDataLayer');\n  },\n\n  _extractFromDataLayerEntry(entry: unknown): void {\n    if (!entry || typeof entry !== 'object') return;\n    const obj = entry as Record<string, unknown>;\n    for (const key of ['user', 'userData', 'user_data', 'customer', 'visitor', 'contact']) {\n      if (obj[key] && typeof obj[key] === 'object') this._extractUserObject(obj[key] as Record<string, unknown>, 'dataLayer');\n    }\n    const ecom = obj.ecommerce as Record<string, unknown> | undefined;\n    const af = (ecom?.purchase as Record<string, unknown> | undefined)?.actionField as Record<string, unknown> | undefined;\n    if (af?.email) this._mergeCapture('dataLayer', { em: af.email as string });\n    this._extractUserObject(obj, 'dataLayer');\n  },\n\n  _extractUserObject(obj: Record<string, unknown>, source: CaptureSource): void {\n    if (!obj) return;\n    const data: Record<string, string> = {};\n    for (const [key, param] of Object.entries(dataLayerFieldMap)) {\n      const val = obj[key];\n      if (val && typeof val === 'string' && val.trim()) data[param] = val.trim();\n    }\n    if (Object.keys(data).length) { this._mergeCapture(source, data as RawUserData); log('AdvancedMatching: data layer captured', Object.keys(data)); }\n  },\n\n  // \u2500\u2500 Meta Tag Capture \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  captureFromMetaTags(): void {\n    const data: Record<string, string> = {};\n\n    for (const script of document.querySelectorAll<HTMLScriptElement>('script[type=\"application/ld+json\"]')) {\n      try {\n        const j = JSON.parse(script.textContent || '') as Record<string, unknown>;\n        if (j.email) data.em = j.email as string;\n        if (j.telephone) data.ph = j.telephone as string;\n        if (j.givenName) data.fn = j.givenName as string;\n        if (j.familyName) data.ln = j.familyName as string;\n        if (j.address && typeof j.address === 'object') {\n          const a = j.address as Record<string, string>;\n          if (a.addressLocality) data.ct = a.addressLocality;\n          if (a.addressRegion) data.st = a.addressRegion;\n          if (a.postalCode) data.zp = a.postalCode;\n          if (a.addressCountry) data.country = a.addressCountry;\n        }\n      } catch { /* */ }\n    }\n\n    const meta = (prop: string) => document.querySelector<HTMLMetaElement>(`meta[property=\"${prop}\"]`)?.content;\n    if (meta('profile:email')) data.em = meta('profile:email')!;\n    if (meta('profile:first_name')) data.fn = meta('profile:first_name')!;\n    if (meta('profile:last_name')) data.ln = meta('profile:last_name')!;\n    if (meta('profile:gender')) data.ge = meta('profile:gender')!;\n\n    if (Object.keys(data).length) { this._mergeCapture('metatag', data as RawUserData); log('AdvancedMatching: meta tags captured', Object.keys(data)); }\n  },\n\n  // \u2500\u2500 Identity Graph \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  _mergeCapture(source: CaptureSource, data: RawUserData): void {\n    for (const [param, value] of Object.entries(data)) {\n      if (!value) continue;\n      const existing = capturedData[param];\n      const existingP = existing ? (sourcePriority[existing.source] ?? 0) : -1;\n      if (!existing || (sourcePriority[source] ?? 0) >= existingP) {\n        capturedData[param] = { value, source };\n      }\n    }\n  },\n\n  getCapturedData(): RawUserData {\n    const r: Record<string, string> = {};\n    for (const [p, e] of Object.entries(capturedData)) r[p] = e.value;\n    return r as RawUserData;\n  },\n\n  async buildUserData(explicitUserData: RawUserData = {}): Promise<HashedUserData> {\n    // Merge: auto-captured \u2192 stored identity \u2192 explicit (highest priority)\n    const merged: Record<string, string> = { ...this.getCapturedData() as Record<string, string> };\n\n    for (const [field, key] of Object.entries(storageMap)) {\n      if (!merged[field] && key) { const v = getFromStorage(key); if (v) merged[field] = v; }\n    }\n\n    for (const [key, value] of Object.entries(explicitUserData)) {\n      if (!value) continue;\n      merged[aliasMap[key] ?? key] = value;\n    }\n\n    const result = await this.normalizeAndHash(merged as RawUserData);\n\n    result.fbp = result.fbp || CookieKeeper.getFbp() || undefined;\n    result.fbc = result.fbc || CookieKeeper.getFbc() || undefined;\n    result.client_user_agent = result.client_user_agent || navigator.userAgent;\n\n    if (!result.external_id) {\n      const vid = CookieKeeper.getVisitorId();\n      if (vid) result.external_id = (await sha256(vid)) ?? undefined;\n    }\n\n    return result;\n  },\n\n  // \u2500\u2500 Match Quality Scoring \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  scoreMatchQuality(userData: HashedUserData): number {\n    const weights: Record<string, number> = {\n      em: 30, ph: 25, external_id: 15, fn: 5, ln: 5,\n      ct: 3, st: 2, zp: 3, country: 2, ge: 2, db: 3,\n      fbp: 5, fbc: 10, client_ip_address: 3, client_user_agent: 2,\n    };\n    let score = 0;\n    for (const [f, w] of Object.entries(weights)) {\n      if ((userData as Record<string, unknown>)[f]) score += w;\n    }\n    return Math.min(score, 100);\n  },\n\n  // \u2500\u2500 Diagnostics \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  getDiagnostics(): AdvancedMatchingDiagnostics {\n    const fields: AdvancedMatchingDiagnostics['fields'] = {};\n    for (const [p, e] of Object.entries(capturedData)) {\n      fields[p] = { source: e.source, hasValue: true, isHashed: isHashed(e.value) };\n    }\n    return {\n      capturedFields: Object.keys(capturedData).length,\n      fields,\n      storedIdentity: {\n        em: !!getFromStorage('_mt_em'), ph: !!getFromStorage('_mt_ph'),\n        fn: !!getFromStorage('_mt_fn'), ln: !!getFromStorage('_mt_ln'),\n        external_id: !!getFromStorage('_mt_eid'),\n      },\n    };\n  },\n\n  resetCapturedData(): void { capturedData = {}; },\n\n  // Re-export for external use\n  aliasMap,\n  storageMap,\n};\n", "/**\n * BrowserPixel \u2014 Auto-load Meta fbevents.js and sync events for deduplication.\n */\nimport { config, log, warn } from './state';\nimport { PixelRouter } from './pixel-router';\n\nconst STANDARD_EVENTS = [\n  'PageView', 'ViewContent', 'AddToCart', 'AddPaymentInfo',\n  'AddToWishlist', 'CompleteRegistration', 'Contact', 'CustomizeProduct',\n  'Donate', 'FindLocation', 'InitiateCheckout', 'Lead', 'Purchase',\n  'Schedule', 'Search', 'StartTrial', 'SubmitApplication', 'Subscribe',\n] as const;\n\nexport const BrowserPixel = {\n  _loaded: false,\n\n  init(): void {\n    if (!config.browserPixel.enabled) return;\n    if (this._loaded) return;\n\n    if (typeof (window as any).fbq === 'function') {\n      log('BrowserPixel: fbq already present, initializing pixels');\n      this._initPixels();\n      this._loaded = true;\n      return;\n    }\n\n    log('BrowserPixel: loading fbevents.js');\n\n    const n: any = (window as any).fbq = function () {\n      n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments);\n    };\n    if (!(window as any)._fbq) (window as any)._fbq = n;\n    n.push = n;\n    n.loaded = true;\n    n.version = '2.0';\n    n.queue = [] as any[];\n\n    const script = document.createElement('script');\n    script.async = true;\n    script.src = 'https://connect.facebook.net/en_US/fbevents.js';\n    const firstScript = document.getElementsByTagName('script')[0];\n    if (firstScript && firstScript.parentNode) {\n      firstScript.parentNode.insertBefore(script, firstScript);\n    } else {\n      const insert = () => {\n        const s = document.getElementsByTagName('script')[0];\n        if (s && s.parentNode) s.parentNode.insertBefore(script, s);\n        else document.head.appendChild(script);\n      };\n      if (document.body) insert();\n      else document.addEventListener('DOMContentLoaded', insert);\n    }\n\n    this._initPixels();\n    this._loaded = true;\n  },\n\n  _initPixels(): void {\n    const pixelIds = PixelRouter.getAllPixelIds();\n    if (!pixelIds.length) { warn('BrowserPixel: no pixel IDs configured'); return; }\n\n    for (const pid of pixelIds) {\n      (window as any).fbq('init', pid);\n      log('BrowserPixel: init pixel', pid);\n    }\n\n    if (config.browserPixel.autoPageView) {\n      (window as any).fbq('track', 'PageView');\n      log('BrowserPixel: PageView fired');\n    }\n  },\n\n  trackEvent(eventName: string, eventId: string, customData: Record<string, unknown> = {}): void {\n    if (!config.browserPixel.enabled || !config.browserPixel.syncEvents) return;\n    if (typeof (window as any).fbq !== 'function') return;\n\n    const isStandard = (STANDARD_EVENTS as readonly string[]).includes(eventName);\n    const fbqParams = { ...customData };\n    const fbqOptions = { eventID: eventId };\n\n    if (isStandard) {\n      (window as any).fbq('track', eventName, fbqParams, fbqOptions);\n    } else {\n      (window as any).fbq('trackCustom', eventName, fbqParams, fbqOptions);\n    }\n\n    log('BrowserPixel: synced', eventName, 'eventID:', eventId);\n  },\n};\n", "/**\n * GTM Integration \u2014 DataLayer bridge for Google Tag Manager.\n *\n * Automatically maps GA4/Enhanced Ecommerce dataLayer events to Meta CAPI\n * events, and optionally pushes MetaTracker events back to the dataLayer\n * for other GTM tags to consume.\n *\n * Supported GA4 ecommerce events:\n *   - page_view       \u2192 PageView\n *   - view_item       \u2192 ViewContent\n *   - add_to_cart     \u2192 AddToCart\n *   - remove_from_cart (logged only)\n *   - add_to_wishlist \u2192 AddToWishlist\n *   - begin_checkout  \u2192 InitiateCheckout\n *   - add_payment_info \u2192 AddPaymentInfo\n *   - purchase        \u2192 Purchase\n *   - sign_up         \u2192 CompleteRegistration\n *   - generate_lead   \u2192 Lead\n *   - search          \u2192 Search\n *   - view_item_list  \u2192 ViewContent\n *   - select_item     \u2192 ViewContent\n */\n\nimport { config, log, warn } from './state';\nimport type { CustomData, RawUserData, GtmConfig } from './types';\n\n// \u2500\u2500 GA4 \u2192 Meta event mapping \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nconst GA4_EVENT_MAP: Record<string, string> = {\n  page_view: 'PageView',\n  view_item: 'ViewContent',\n  view_item_list: 'ViewContent',\n  select_item: 'ViewContent',\n  add_to_cart: 'AddToCart',\n  add_to_wishlist: 'AddToWishlist',\n  begin_checkout: 'InitiateCheckout',\n  add_payment_info: 'AddPaymentInfo',\n  purchase: 'Purchase',\n  refund: '', // skip\n  remove_from_cart: '', // skip\n  sign_up: 'CompleteRegistration',\n  generate_lead: 'Lead',\n  search: 'Search',\n  login: '', // skip \u2014 no direct Meta equivalent\n  view_cart: 'ViewContent',\n  add_shipping_info: 'AddPaymentInfo',\n  select_promotion: 'ViewContent',\n};\n\n// \u2500\u2500 Ecommerce data extraction \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\ninterface GA4Item {\n  item_id?: string;\n  item_name?: string;\n  item_category?: string;\n  price?: number;\n  quantity?: number;\n  [key: string]: unknown;\n}\n\ninterface GA4EcommerceData {\n  items?: GA4Item[];\n  value?: number;\n  currency?: string;\n  transaction_id?: string;\n  shipping?: number;\n  tax?: number;\n  coupon?: string;\n  search_term?: string;\n  [key: string]: unknown;\n}\n\nfunction extractCustomData(eventName: string, ecommerce: GA4EcommerceData | undefined, dlEntry: Record<string, unknown>): CustomData {\n  const cd: CustomData = {};\n\n  const ecom = ecommerce ?? {};\n\n  // Value & currency\n  if (ecom.value !== undefined) cd.value = Number(ecom.value);\n  if (ecom.currency) cd.currency = String(ecom.currency);\n\n  // Transaction / order ID\n  if (ecom.transaction_id) cd.order_id = String(ecom.transaction_id);\n\n  // Search\n  if (ecom.search_term) cd.search_string = String(ecom.search_term);\n  if (dlEntry.search_term) cd.search_string = String(dlEntry.search_term);\n\n  // Items \u2192 content_ids, contents, num_items, content_type\n  if (Array.isArray(ecom.items) && ecom.items.length) {\n    cd.content_ids = ecom.items\n      .map((item) => item.item_id ?? item.item_name ?? '')\n      .filter(Boolean);\n\n    cd.contents = ecom.items.map((item) => ({\n      id: String(item.item_id ?? item.item_name ?? ''),\n      quantity: item.quantity ?? 1,\n      item_price: item.price,\n    }));\n\n    cd.num_items = ecom.items.reduce((sum, item) => sum + (item.quantity ?? 1), 0);\n\n    // Infer content_type\n    cd.content_type = 'product';\n\n    // Content name from first item\n    if (ecom.items[0]?.item_name) cd.content_name = ecom.items[0].item_name;\n\n    // Category from first item\n    if (ecom.items[0]?.item_category) cd.content_category = ecom.items[0].item_category;\n  }\n\n  // Fallback value from items if not set\n  if (cd.value === undefined && cd.contents?.length) {\n    cd.value = cd.contents.reduce(\n      (sum, c) => sum + ((c.item_price ?? 0) * (c.quantity ?? 1)), 0,\n    );\n  }\n\n  return cd;\n}\n\nfunction extractUserData(dlEntry: Record<string, unknown>): RawUserData {\n  const ud: Record<string, string> = {};\n\n  // Look for user data in common dataLayer patterns\n  const userKeys = ['user', 'userData', 'user_data', 'customer', 'visitor', 'contact'];\n  for (const key of userKeys) {\n    if (dlEntry[key] && typeof dlEntry[key] === 'object') {\n      const obj = dlEntry[key] as Record<string, unknown>;\n      if (obj.email || obj.em) ud.em = String(obj.email ?? obj.em);\n      if (obj.phone || obj.ph) ud.ph = String(obj.phone ?? obj.ph);\n      if (obj.first_name || obj.fn || obj.firstName) ud.fn = String(obj.first_name ?? obj.fn ?? obj.firstName);\n      if (obj.last_name || obj.ln || obj.lastName) ud.ln = String(obj.last_name ?? obj.ln ?? obj.lastName);\n      if (obj.external_id || obj.user_id || obj.userId) ud.external_id = String(obj.external_id ?? obj.user_id ?? obj.userId);\n      if (obj.city || obj.ct) ud.ct = String(obj.city ?? obj.ct);\n      if (obj.state || obj.st) ud.st = String(obj.state ?? obj.st);\n      if (obj.zip || obj.zp || obj.postal_code) ud.zp = String(obj.zip ?? obj.zp ?? obj.postal_code);\n      if (obj.country || obj.country_code) ud.country = String(obj.country ?? obj.country_code);\n    }\n  }\n\n  // Also check top-level user fields (some implementations put them directly)\n  if (dlEntry.user_id) ud.external_id = ud.external_id || String(dlEntry.user_id);\n  if (dlEntry.userId) ud.external_id = ud.external_id || String(dlEntry.userId);\n\n  return ud as RawUserData;\n}\n\n// \u2500\u2500 Module state \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nlet _initialized = false;\nlet _originalPush: ((...args: unknown[]) => number) | null = null;\n\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n// \u2500\u2500 EXPORTED MODULE\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\nexport const GtmIntegration = {\n\n  init(): void {\n    if (!config.gtm.enabled) return;\n    if (_initialized) return;\n\n    try {\n      log('GTM: initializing dataLayer bridge');\n\n      const dlKey = config.gtm.dataLayerKey || 'dataLayer';\n      const dl = window[dlKey] as unknown[] | undefined;\n\n      if (!Array.isArray(dl)) {\n        // Create dataLayer if it doesn't exist\n        (window as Record<string, unknown>)[dlKey] = [];\n        log('GTM: created', dlKey);\n      }\n\n      const dataLayer = (window as Record<string, unknown>)[dlKey] as unknown[];\n\n      // Process existing entries\n      if (config.gtm.autoMapEcommerce) {\n        for (const entry of dataLayer) {\n          try {\n            this._processEntry(entry);\n          } catch (err) {\n            warn('GTM: error processing existing dataLayer entry', err);\n          }\n        }\n      }\n\n      // Intercept future pushes\n      _originalPush = dataLayer.push.bind(dataLayer);\n      dataLayer.push = (...args: unknown[]): number => {\n        const result = _originalPush!(...args);\n        if (config.gtm.autoMapEcommerce) {\n          for (const entry of args) {\n            try {\n              this._processEntry(entry);\n            } catch (err) {\n              warn('GTM: error processing dataLayer push', err);\n            }\n          }\n        }\n        return result;\n      };\n\n      _initialized = true;\n      log('GTM: dataLayer bridge active');\n    } catch (err) {\n      warn('GTM: failed to initialize dataLayer bridge', err);\n    }\n  },\n\n  /**\n   * Process a single dataLayer entry and fire the corresponding Meta event.\n   */\n  _processEntry(entry: unknown): void {\n    if (!entry || typeof entry !== 'object') return;\n\n    const obj = entry as Record<string, unknown>;\n    const event = obj.event as string | undefined;\n    if (!event || typeof event !== 'string') return;\n\n    // Skip internal GTM events and our own events to prevent loops\n    if (event.startsWith('gtm.')) return;\n    if (obj._source === 'meta-capi-tracker') return;\n\n    // Resolve Meta event name\n    const metaEvent = this._resolveEventName(event);\n    if (!metaEvent) return;\n\n    // Extract ecommerce and user data with defensive error handling\n    let customData: CustomData = {};\n    let userData: RawUserData = {};\n\n    try {\n      const ecommerce = obj.ecommerce as GA4EcommerceData | undefined;\n      customData = extractCustomData(event, ecommerce, obj);\n      userData = extractUserData(obj);\n    } catch (err) {\n      warn('GTM: error extracting data from dataLayer entry', event, err);\n      return;\n    }\n\n    log('GTM: mapping', event, '\u2192', metaEvent);\n\n    // Fire MetaTracker event (without re-pushing to dataLayer to avoid loops)\n    if (window.MetaTracker && typeof window.MetaTracker.track === 'function') {\n      window.MetaTracker.track(metaEvent, customData, userData).catch((err: unknown) => {\n        warn('GTM: failed to track mapped event', metaEvent, err);\n      });\n    }\n  },\n\n  /**\n   * Resolve a dataLayer event name to a Meta CAPI event name.\n   */\n  _resolveEventName(dlEvent: string): string | null {\n    // Custom mapping takes priority\n    const custom = config.gtm.eventMapping[dlEvent];\n    if (custom) return custom;\n\n    // Built-in GA4 mapping\n    const mapped = GA4_EVENT_MAP[dlEvent];\n    if (mapped !== undefined) return mapped || null; // empty string = skip\n\n    return null; // Unknown event \u2014 don't map\n  },\n\n  /**\n   * Push an event to the GTM dataLayer.\n   */\n  pushToDataLayer(event: string, data: Record<string, unknown> = {}): void {\n    try {\n      const dlKey = config.gtm.dataLayerKey || 'dataLayer';\n      const dl = window[dlKey] as unknown[] | undefined;\n\n      if (!Array.isArray(dl)) {\n        warn('GTM: dataLayer not found, cannot push event');\n        return;\n      }\n\n      // Use the original push to avoid our interceptor re-processing this event\n      const pushFn = _originalPush ?? dl.push.bind(dl);\n\n      pushFn({\n        event,\n        ...data,\n        _source: 'meta-capi-tracker',\n      });\n\n      log('GTM: pushed to dataLayer:', event);\n    } catch (err) {\n      warn('GTM: error pushing to dataLayer', event, err);\n    }\n  },\n\n  /**\n   * Push a MetaTracker event result to the dataLayer for other GTM tags.\n   */\n  notifyDataLayer(eventName: string, eventId: string | undefined, customData: CustomData = {}): void {\n    if (!config.gtm.enabled || !config.gtm.pushToDataLayer) return;\n\n    try {\n      this.pushToDataLayer('meta_capi_event', {\n        meta_event_name: eventName,\n        meta_event_id: eventId,\n        meta_custom_data: customData,\n      });\n    } catch (err) {\n      warn('GTM: error notifying dataLayer', eventName, err);\n    }\n  },\n\n  isInitialized(): boolean {\n    return _initialized;\n  },\n};\n"],
  "mappings": "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",
  "names": ["index_exports", "__export", "MetaTracker", "index_default", "VERSION", "RETRY_DELAYS", "BATCH_INTERVAL", "config", "queue", "batchTimer", "initialized", "transportMethod", "adBlockDetected", "cookieKeeperTimer", "mergeConfig", "opts", "setInitialized", "v", "setTransportMethod", "setAdBlockDetected", "setBatchTimer", "setCookieKeeperTimer", "log", "args", "config", "warn", "sha256", "value", "data", "hash", "b", "isHashed", "generateEventId", "generateVisitorId", "stored", "getFromStorage", "id", "saveToStorage", "getRootDomain", "parts", "setCookie", "name", "days", "maxAge", "secure", "domain", "domainStr", "getCookie", "match", "deleteCookie", "key", "c", "config", "removeFromStorage", "AdBlockRecovery", "config", "testUrl", "ctrl", "t", "r", "setAdBlockDetected", "log", "path", "adBlockDetected", "eps", "ep", "data", "VERSION", "h", "resolveEndpoint", "path", "adBlockDetected", "AdBlockRecovery", "config", "viaFetch", "url", "data", "body", "r", "viaBeacon", "blob", "viaXhr", "resolve", "reject", "xhr", "k", "v", "viaImage", "params", "imgUrl", "img", "transportSend", "attempt", "transports", "t", "transport", "pathSuffix", "endpoints", "ep", "result", "transportMethod", "log", "setTransportMethod", "e", "RETRY_DELAYS", "warn", "CookieKeeper", "config", "log", "name", "getCookie", "b", "setCookie", "fbclid", "saveToStorage", "getFromStorage", "generateVisitorId", "cookies", "last", "transportSend", "resolveEndpoint", "e", "warn", "v", "cookieKeeperTimer", "setCookieKeeperTimer", "PixelRouter", "hostname", "config", "matched", "catchAll", "pc", "pattern", "suffix", "p", "capturedData", "normalizers", "v", "d", "fmts", "rx", "m", "fieldPatterns", "sourcePriority", "dataLayerFieldMap", "aliasMap", "storageMap", "PII_FIELDS", "NON_PII_FIELDS", "AdvancedMatching", "config", "log", "field", "value", "isHashed", "fn", "userData", "result", "normalized", "sha256", "input", "type", "name", "id", "ac", "ph", "sel", "param", "p", "n", "i", "x", "form", "data", "inputs", "parts", "e", "startObserving", "f", "muts", "mut", "node", "forms", "params", "ln", "cc", "dlKey", "dl", "entry", "origPush", "args", "r", "udk", "obj", "key", "af", "source", "val", "script", "j", "a", "meta", "prop", "existing", "existingP", "explicitUserData", "merged", "getFromStorage", "CookieKeeper", "vid", "weights", "score", "w", "fields", "STANDARD_EVENTS", "BrowserPixel", "config", "log", "n", "script", "firstScript", "insert", "s", "pixelIds", "PixelRouter", "warn", "pid", "eventName", "eventId", "customData", "isStandard", "fbqParams", "fbqOptions", "GA4_EVENT_MAP", "extractCustomData", "eventName", "ecommerce", "dlEntry", "cd", "ecom", "item", "sum", "c", "extractUserData", "ud", "userKeys", "key", "obj", "_initialized", "_originalPush", "GtmIntegration", "config", "log", "dlKey", "dl", "dataLayer", "entry", "err", "warn", "args", "result", "event", "metaEvent", "customData", "userData", "dlEvent", "custom", "mapped", "data", "eventId", "sendEvents", "events", "url", "resolveEndpoint", "body", "transportSend", "e", "warn", "flushQueue", "queue", "enqueueEvent", "event", "config", "batchTimer", "setBatchTimer", "BATCH_INTERVAL", "MetaTracker", "VERSION", "options", "initialized", "mergeConfig", "setInitialized", "log", "CookieKeeper", "AdvancedMatching", "BrowserPixel", "GtmIntegration", "AdBlockRecovery", "blocked", "eventName", "customData", "userData", "eventId", "generateEventId", "enrichedUserData", "matchScore", "pixelIds", "PixelRouter", "pixelId", "ud", "cd", "name", "normalized", "key", "value", "hashed", "field", "storageKey", "val", "saveToStorage", "k", "removeFromStorage", "domains", "p", "adBlockDetected", "transportMethod", "extraUserData", "data", "source", "method", "args", "fn", "index_default", "MetaTracker"]
}
