/**
 * Meta CAPI Tracker - GTM Integration Guide
 * ==========================================
 *
 * Two integration methods:
 *
 * METHOD 1: Automatic GA4 Event Mapping (Recommended)
 *   - Enable gtm.autoMapEcommerce in the init config
 *   - GA4 ecommerce events pushed to dataLayer are auto-mapped
 *   - No additional tags needed for standard events
 *
 * METHOD 2: Manual Custom HTML Tags
 *   - Create individual Custom HTML tags per event
 *   - Full control over what data is sent
 *   - Use for custom events or override auto-mapping
 *
 * Setup:
 *   1. Create a Custom HTML tag in GTM
 *   2. Paste the initialization code below
 *   3. Set trigger to "All Pages"
 *   4. Optionally create additional tags for manual events
 */

<!-- ================================================================ -->
<!-- METHOD 1: Automatic GA4 Mapping (Recommended)                    -->
<!-- ================================================================ -->

<!-- Tag: MetaTracker Init with GTM Bridge (trigger: All Pages) -->
<script src="https://your-server.com/api/v1/track.js"></script>
<script>
  MetaTracker.init({
    endpoint: 'https://your-server.com/api/v1/track',
    apiKey:   '{{Constant - Tracking API Key}}',  // GTM Constant Variable
    pixelId:  '{{Constant - Meta Pixel ID}}',     // GTM Constant Variable
    autoPageView: true,
    debug: {{Debug Mode}},  // GTM built-in variable

    // Enable GTM DataLayer bridge — GA4 events auto-map to Meta CAPI
    gtm: {
      enabled: true,
      autoMapEcommerce: true,   // Auto-map: purchase → Purchase, add_to_cart → AddToCart, etc.
      pushToDataLayer: true,    // Push meta_capi_event back to dataLayer for other tags
      eventMapping: {
        // Add custom mappings here (dataLayer event → Meta event)
        // 'custom_signup': 'CompleteRegistration',
        // 'custom_lead': 'Lead',
      },
    },

    advancedMatching: {
      enabled: true,
      autoCaptureForms: true,
      captureDataLayer: true,   // Capture user data from dataLayer
    },
    cookieKeeper: { enabled: true },
    adBlockRecovery: { enabled: true },
  });
</script>

<!--
  With autoMapEcommerce enabled, these GA4 dataLayer pushes are
  automatically mapped — no extra tags needed:

  dataLayer.push({ event: 'view_item', ecommerce: { items: [...] } });
    → MetaTracker.track('ViewContent', ...)

  dataLayer.push({ event: 'add_to_cart', ecommerce: { items: [...] } });
    → MetaTracker.track('AddToCart', ...)

  dataLayer.push({ event: 'purchase', ecommerce: { value: 99.99, ... } });
    → MetaTracker.track('Purchase', ...)

  Full mapping table:
    page_view         → PageView
    view_item         → ViewContent
    view_item_list    → ViewContent
    add_to_cart       → AddToCart
    add_to_wishlist   → AddToWishlist
    begin_checkout    → InitiateCheckout
    add_payment_info  → AddPaymentInfo
    purchase          → Purchase
    sign_up           → CompleteRegistration
    generate_lead     → Lead
    search            → Search
-->


<!-- ================================================================ -->
<!-- METHOD 2: Manual Custom HTML Tags                                -->
<!-- ================================================================ -->

<!-- Tag: MetaTracker Init (trigger: All Pages) -->
<script src="https://your-server.com/api/v1/track.js"></script>
<script>
  MetaTracker.init({
    endpoint: 'https://your-server.com/api/v1/track',
    apiKey:   '{{Constant - Tracking API Key}}',
    pixelId:  '{{Constant - Meta Pixel ID}}',
    autoPageView: true,
    debug: {{Debug Mode}},
  });
</script>

<!-- Tag: Purchase Event (trigger: purchase dataLayer event) -->
<script>
  (function() {
    MetaTracker.trackPurchase({
      value:        {{DLV - transaction_total}},
      currency:     {{DLV - currency}} || 'USD',
      content_ids:  {{DLV - product_ids}},
      content_type: 'product',
      order_id:     {{DLV - transaction_id}},
      num_items:    {{DLV - num_items}},
    }, {
      em: {{DLV - user_email}},
      ph: {{DLV - user_phone}},
      external_id: {{DLV - user_id}},
    });
  })();
</script>

<!-- Tag: Lead Event (trigger: form submission) -->
<script>
  (function() {
    MetaTracker.trackLead({
      value:        {{DLV - lead_value}} || 0,
      currency:     'USD',
      content_name: {{DLV - form_name}},
    }, {
      em: {{DLV - form_email}},
      fn: {{DLV - form_first_name}},
      ln: {{DLV - form_last_name}},
      ph: {{DLV - form_phone}},
    });
  })();
</script>

<!-- Tag: ViewContent (trigger: product page view) -->
<script>
  (function() {
    MetaTracker.trackViewContent({
      content_name: {{DLV - product_name}},
      content_ids:  [{{DLV - product_id}}],
      content_type: 'product',
      value:        {{DLV - product_price}},
      currency:     {{DLV - currency}} || 'USD',
    });
  })();
</script>

<!-- Tag: AddToCart (trigger: add_to_cart dataLayer event) -->
<script>
  (function() {
    MetaTracker.trackAddToCart({
      content_ids:  [{{DLV - product_id}}],
      content_name: {{DLV - product_name}},
      content_type: 'product',
      value:        {{DLV - product_price}},
      currency:     {{DLV - currency}} || 'USD',
    });
  })();
</script>

<!-- Tag: InitiateCheckout (trigger: begin_checkout dataLayer event) -->
<script>
  (function() {
    MetaTracker.trackInitiateCheckout({
      value:    {{DLV - cart_total}},
      currency: {{DLV - currency}} || 'USD',
      num_items: {{DLV - cart_item_count}},
    });
  })();
</script>

<!-- Tag: CompleteRegistration (trigger: sign_up dataLayer event) -->
<script>
  (function() {
    MetaTracker.trackCompleteRegistration({
      content_name: {{DLV - registration_method}} || 'Website',
    }, {
      em: {{DLV - user_email}},
      fn: {{DLV - user_first_name}},
      ln: {{DLV - user_last_name}},
      external_id: {{DLV - user_id}},
    });
  })();
</script>

<!-- Tag: Search (trigger: search dataLayer event) -->
<script>
  (function() {
    MetaTracker.trackSearch({
      search_string: {{DLV - search_term}},
    });
  })();
</script>

<!-- Tag: Push custom data to dataLayer for other GTM tags -->
<script>
  // After any event, the GTM bridge pushes 'meta_capi_event' to dataLayer:
  // { event: 'meta_capi_event', meta_event_name: 'Purchase', meta_event_id: '...', ... }
  // You can use this as a trigger for other GTM tags (e.g., logging, analytics).
</script>
