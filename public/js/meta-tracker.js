(function(l,u){const T="2.1.0",N=[1e3,5e3,15e3],q=2e3;let i={endpoint:void 0,apiKey:void 0,pixelId:void 0,pixels:[],autoPageView:!0,debug:!1,hashPii:!0,respectDnt:!1,batchEvents:!0,browserPixel:{enabled:!0,autoPageView:!0,syncEvents:!0},consent:{enabled:!1,mode:"opt-in",consentCategory:"C0004",waitForConsent:!0,defaultConsent:!1},cookieKeeper:{enabled:!0,refreshInterval:864e5,maxAge:180,cookieNames:["_fbp","_fbc","_mt_id"]},adBlockRecovery:{enabled:!0,proxyPath:"/collect",useBeacon:!0,useImage:!0,customEndpoints:[]},advancedMatching:{enabled:!0,autoCaptureForms:!0,captureUrlParams:!0,captureDataLayer:!0,captureMetaTags:!0,autoIdentifyOnSubmit:!0,formFieldMap:{},dataLayerKey:"dataLayer",userDataKey:null}},I=[],S=null,x=!1,M="fetch",g=!1,A=null;function d(...e){i.debug&&console.log("[MetaTracker]",...e)}function h(...e){i.debug&&console.warn("[MetaTracker]",...e)}function U(){return`evt_${Date.now().toString(36)}_${Math.random().toString(36).substring(2,10)}`}function V(){const e=p("_mt_id");if(e)return e;const t="mt."+Date.now().toString(36)+"."+Math.random().toString(36).substring(2,12);return k("_mt_id",t),t}async function K(e){if(!e)return null;const t=e.toString().trim().toLowerCase(),a=new TextEncoder().encode(t),r=await crypto.subtle.digest("SHA-256",a);return Array.from(new Uint8Array(r)).map(o=>o.toString(16).padStart(2,"0")).join("")}function z(e){return typeof e=="string"&&/^[a-f0-9]{64}$/.test(e)}function L(e,t,n){const a=n*86400,r=location.protocol==="https:"?"; Secure":"",o=$(),c=o?`; domain=.${o}`:"";u.cookie=`${e}=${encodeURIComponent(t)}; path=/${c}; max-age=${a}; SameSite=Lax${r}`}function F(e){const t=u.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?decodeURIComponent(t[2]):null}function H(e){const t=$(),n=t?`; domain=.${t}`:"";u.cookie=`${e}=; path=/${n}; max-age=0`}function $(){try{const e=l.location.hostname.split(".");return e.length<=1||/^\d+$/.test(e[e.length-1])?"":e.slice(-2).join(".")}catch{return""}}function p(e){const t=F(e);if(t)return t;try{return localStorage.getItem("mt_"+e)}catch{return null}}function k(e,t,n){n=n||i.cookieKeeper.maxAge||180,L(e,t,n);try{localStorage.setItem("mt_"+e,t)}catch{}}function G(e){H(e);try{localStorage.removeItem("mt_"+e)}catch{}}const m={_capturedData:{},_formObserver:null,_formListeners:new WeakSet,init(){i.advancedMatching.enabled&&(d("AdvancedMatching: initializing"),i.advancedMatching.captureUrlParams&&this.captureFromUrl(),i.advancedMatching.captureMetaTags&&this.captureFromMetaTags(),i.advancedMatching.captureDataLayer&&this.captureFromDataLayer(),i.advancedMatching.autoCaptureForms&&this.watchForms(),d("AdvancedMatching: ready, captured:",Object.keys(this._capturedData)))},normalizers:{em(e){return!e||typeof e!="string"||(e=e.trim().toLowerCase(),!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))?null:e},ph(e){if(!e||typeof e!="string")return null;let t=e.replace(/\D/g,"");return t.length<7?null:(t.startsWith("00")&&(t=t.substring(2)),t||null)},fn(e){if(!e||typeof e!="string")return null;let t=e.trim().toLowerCase();t=t.replace(/^(mr|mrs|ms|miss|dr|prof)\.?\s*/i,""),t=t.replace(/[^a-z\s\u00C0-\u024F]/g,"");try{t=t.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}catch{}return t.trim()||null},ln(e){return m.normalizers.fn(e)},ge(e){if(!e||typeof e!="string")return null;const t=e.trim().toLowerCase();return t.startsWith("m")||t==="male"?"m":t.startsWith("f")||t==="female"?"f":null},db(e){if(!e||typeof e!="string")return null;const t=e.trim();if(/^\d{8}$/.test(t))return t;const n=[/^(\d{4})-(\d{2})-(\d{2})$/,/^(\d{2})\/(\d{2})\/(\d{4})$/,/^(\d{2})-(\d{2})-(\d{4})$/];for(const a of n){const r=t.match(a);if(r)return r[1].length===4?r[1]+r[2]+r[3]:r[3]+r[1]+r[2]}return null},ct(e){if(!e||typeof e!="string")return null;let t=e.trim().toLowerCase();t=t.replace(/[^a-z\s\u00C0-\u024F]/g,"");try{t=t.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}catch{}return t.trim()||null},st(e){if(!e||typeof e!="string")return null;const t=e.trim().toLowerCase();if(/^[a-z]{2}$/.test(t))return t;const n=t.match(/\b([a-z]{2})\b/);return n?n[1]:t.substring(0,2)},zp(e){if(!e||typeof e!="string")return null;const t=e.trim().toLowerCase().replace(/\s+/g,"");return/^\d{5}(-\d{4})?$/.test(t)?t.substring(0,5):t||null},country(e){if(!e||typeof e!="string")return null;const t=e.trim().toLowerCase();return/^[a-z]{2}$/.test(t)?t:{"united states":"us",usa:"us","united kingdom":"gb",uk:"gb",canada:"ca",australia:"au",germany:"de",france:"fr",indonesia:"id",japan:"jp",india:"in",brazil:"br",mexico:"mx",spain:"es",italy:"it",netherlands:"nl",singapore:"sg",malaysia:"my",philippines:"ph",thailand:"th",vietnam:"vn","south korea":"kr",china:"cn",taiwan:"tw","hong kong":"hk","new zealand":"nz",portugal:"pt",sweden:"se",norway:"no",denmark:"dk",finland:"fi",poland:"pl",cambodia:"kh",turkey:"tr",argentina:"ar",colombia:"co",chile:"cl",peru:"pe","south africa":"za",nigeria:"ng",egypt:"eg","saudi arabia":"sa","united arab emirates":"ae",uae:"ae",russia:"ru",ukraine:"ua",ireland:"ie",switzerland:"ch",austria:"at",belgium:"be","czech republic":"cz",romania:"ro"}[t]||(t.length===2?t:null)},external_id(e){return!e||typeof e!="string"?null:e.trim()||null}},normalize(e,t){if(z(t))return t;const n=this.normalizers[e];return n?n(t):t?String(t).trim().toLowerCase():null},async normalizeAndHash(e){if(!e)return{};const t=["em","ph","fn","ln","ge","db","ct","st","zp","country","external_id"],n={};for(const r of t){const o=e[r];if(!o)continue;if(z(o)){n[r]=o;continue}const c=this.normalize(r,o);c&&(i.hashPii?n[r]=await K(c)??void 0:n[r]=c)}const a=["client_ip_address","client_user_agent","fbc","fbp","subscription_id","fb_login_id","lead_id"];for(const r of a){const o=e[r];o&&(n[r]=o)}return n},_fieldPatterns:{em:{types:["email"],names:["email","e-mail","user_email","userEmail","customer_email","login","username","emailAddress","email_address"],ids:["email","user-email","customer-email","signup-email","login-email"],autocomplete:["email"],placeholders:["email","e-mail","your email","email address"]},ph:{types:["tel"],names:["phone","telephone","tel","mobile","phone_number","phoneNumber","cell","cellphone","mobile_number","contact_number","whatsapp"],ids:["phone","telephone","mobile","phone-number"],autocomplete:["tel","tel-national","tel-local"],placeholders:["phone","telephone","mobile","whatsapp","nomor telepon","hp"]},fn:{names:["first_name","firstName","fname","given-name","givenName","first","name_first","billing_first_name"],ids:["first-name","firstname","fname","given-name"],autocomplete:["given-name"],placeholders:["first name","given name","nama depan"]},ln:{names:["last_name","lastName","lname","family-name","familyName","surname","last","name_last","billing_last_name"],ids:["last-name","lastname","lname","family-name","surname"],autocomplete:["family-name"],placeholders:["last name","family name","surname","nama belakang"]},ct:{names:["city","town","billing_city","shipping_city","address_city"],ids:["city","billing-city","shipping-city"],autocomplete:["address-level2"],placeholders:["city","town","kota"]},st:{names:["state","province","region","billing_state","shipping_state"],ids:["state","province","region","billing-state"],autocomplete:["address-level1"],placeholders:["state","province","region","provinsi"]},zp:{names:["zip","zipcode","zip_code","postal","postal_code","postcode","billing_zip","billing_postcode","shipping_zip"],ids:["zip","zipcode","postal-code","postcode"],autocomplete:["postal-code"],placeholders:["zip","postal code","zip code","kode pos"]},country:{names:["country","country_code","countryCode","billing_country","shipping_country"],ids:["country","billing-country","shipping-country"],autocomplete:["country","country-name"],placeholders:["country","negara"]},ge:{names:["gender","sex"],ids:["gender","sex"],autocomplete:["sex"],placeholders:["gender","jenis kelamin"]},db:{names:["birthday","birthdate","date_of_birth","dob","dateOfBirth","birth_date","bday"],ids:["birthday","birthdate","dob","date-of-birth"],autocomplete:["bday"],placeholders:["birthday","date of birth","tanggal lahir"]}},detectFieldParam(e){const t=(e.type||"").toLowerCase(),n=(e.name||"").toLowerCase(),a=(e.id||"").toLowerCase(),r=(e.autocomplete||"").toLowerCase(),o=("placeholder"in e&&e.placeholder||"").toLowerCase();if(i.advancedMatching.formFieldMap)for(const[c,s]of Object.entries(i.advancedMatching.formFieldMap))try{if(e.matches(c))return s}catch{}for(const[c,s]of Object.entries(this._fieldPatterns))if("types"in s&&s.types&&s.types.includes(t)||s.names&&s.names.some(f=>n.includes(f))||s.ids&&s.ids.some(f=>a.includes(f))||s.autocomplete&&s.autocomplete.includes(r)||s.placeholders&&s.placeholders.some(f=>o.includes(f)))return c;return["name","full_name","fullname","customer_name"].includes(n)||["name","full-name","fullname"].includes(a)?"_fullname":null},scanForm(e){const t={},n=e.querySelectorAll("input, select, textarea");for(const a of n){if(a.type==="hidden"||a.type==="password"||a.type==="submit")continue;const r=a.value?.trim();if(!r)continue;const o=this.detectFieldParam(a);if(o)if(o==="_fullname"){const c=r.split(/\s+/);c.length>=2?(t.fn=t.fn||c[0],t.ln=t.ln||c.slice(1).join(" ")):t.fn=t.fn||r}else t[o]=t[o]||r}return t},watchForms(){u.addEventListener("submit",t=>{const n=t.target;if(!(n instanceof HTMLFormElement))return;const a=this.scanForm(n);Object.keys(a).length>0&&(this._mergeCapture("form",a),d("AdvancedMatching: form submit captured",Object.keys(a)),i.advancedMatching.autoIdentifyOnSubmit&&(a.em||a.ph)&&v.identify(a))},!0),u.addEventListener("change",t=>{const n=t.target;if(!(n instanceof HTMLInputElement)&&!(n instanceof HTMLSelectElement))return;const a=n.value?.trim();if(!a)return;const r=this.detectFieldParam(n);!r||r==="_fullname"||(this._mergeCapture("form",{[r]:a}),d("AdvancedMatching: field captured",r))},!0);const e=()=>{this._scanExistingForms(),l.MutationObserver&&u.body&&(this._formObserver=new MutationObserver(t=>{for(const n of t)for(const a of n.addedNodes){if(a.nodeType!==1)continue;const r=a;r.tagName==="FORM"?this._scanSingleForm(r):r.querySelectorAll&&r.querySelectorAll("form").forEach(o=>this._scanSingleForm(o))}}),this._formObserver.observe(u.body,{childList:!0,subtree:!0}))};u.body?e():u.addEventListener("DOMContentLoaded",e)},_scanExistingForms(){u.querySelectorAll("form").forEach(e=>this._scanSingleForm(e))},_scanSingleForm(e){const t=this.scanForm(e);Object.keys(t).length>0&&(this._mergeCapture("form_prefill",t),d("AdvancedMatching: pre-filled form scanned",Object.keys(t)))},captureFromUrl(){try{const t=new URL(l.location.href).searchParams,n={},a=["email","em","e","user_email","customer_email"];for(const c of a){const s=t.get(c);if(s&&s.includes("@")){n.em=s;break}}const r=["phone","ph","tel","mobile","whatsapp"];for(const c of r){const s=t.get(c);if(s&&s.replace(/\D/g,"").length>=7){n.ph=s;break}}(t.get("first_name")||t.get("fn"))&&(n.fn=t.get("first_name")||t.get("fn")||void 0),(t.get("last_name")||t.get("ln"))&&(n.ln=t.get("last_name")||t.get("ln")||void 0);const o=["external_id","eid","user_id","uid","customer_id","player_id"];for(const c of o){const s=t.get(c);if(s){n.external_id=s;break}}(t.get("country")||t.get("cc"))&&(n.country=t.get("country")||t.get("cc")||void 0),Object.keys(n).length>0&&(this._mergeCapture("url",n),d("AdvancedMatching: URL params captured",Object.keys(n)))}catch{}},captureFromDataLayer(){const e=i.advancedMatching.dataLayerKey||"dataLayer",t=l[e];if(Array.isArray(t)){for(const r of t)this._extractFromDataLayerEntry(r);const a=t.push.bind(t);t.push=(...r)=>{const o=a(...r);for(const c of r)this._extractFromDataLayerEntry(c);return o}}const n=i.advancedMatching.userDataKey;n&&l[n]&&this._extractUserObject(l[n],"customDataLayer")},_extractFromDataLayerEntry(e){if(!e||typeof e!="object")return;const t=["user","userData","user_data","customer","visitor","contact"];for(const n of t)e[n]&&typeof e[n]=="object"&&this._extractUserObject(e[n],"dataLayer");if(e.ecommerce){const n=e.ecommerce;if(n.purchase?.actionField){const a=n.purchase.actionField;a.email&&this._mergeCapture("dataLayer",{em:a.email})}}this._extractUserObject(e,"dataLayer")},_extractUserObject(e,t){if(!e||typeof e!="object")return;const n={},a={email:"em",em:"em",user_email:"em",customerEmail:"em",phone:"ph",ph:"ph",telephone:"ph",mobile:"ph",phoneNumber:"ph",first_name:"fn",fn:"fn",firstName:"fn",givenName:"fn",last_name:"ln",ln:"ln",lastName:"ln",familyName:"ln",surname:"ln",gender:"ge",ge:"ge",sex:"ge",date_of_birth:"db",db:"db",birthday:"db",dob:"db",birthdate:"db",city:"ct",ct:"ct",town:"ct",state:"st",st:"st",province:"st",region:"st",zip:"zp",zp:"zp",zipcode:"zp",postal_code:"zp",postcode:"zp",country:"country",country_code:"country",countryCode:"country",external_id:"external_id",user_id:"external_id",userId:"external_id",customer_id:"external_id",customerId:"external_id"};for(const[r,o]of Object.entries(a)){const c=e[r];c&&typeof c=="string"&&c.trim()&&(n[o]=c.trim())}Object.keys(n).length>0&&(this._mergeCapture(t,n),d("AdvancedMatching: data layer captured",Object.keys(n)))},captureFromMetaTags(){const e={},t=u.querySelectorAll('script[type="application/ld+json"]');for(const c of t)try{const s=JSON.parse(c.textContent||"{}");if(s.email&&(e.em=s.email),s.telephone&&(e.ph=s.telephone),s.givenName&&(e.fn=s.givenName),s.familyName&&(e.ln=s.familyName),s.address&&typeof s.address=="object"){const f=s.address;f.addressLocality&&(e.ct=f.addressLocality),f.addressRegion&&(e.st=f.addressRegion),f.postalCode&&(e.zp=f.postalCode),f.addressCountry&&(e.country=f.addressCountry)}}catch{}const n=u.querySelector('meta[property="profile:email"]');n?.content&&(e.em=n.content);const a=u.querySelector('meta[property="profile:first_name"]');a?.content&&(e.fn=a.content);const r=u.querySelector('meta[property="profile:last_name"]');r?.content&&(e.ln=r.content);const o=u.querySelector('meta[property="profile:gender"]');o?.content&&(e.ge=o.content),Object.keys(e).length>0&&(this._mergeCapture("metatag",e),d("AdvancedMatching: meta tags captured",Object.keys(e)))},_sourcePriority:{explicit:100,identify:90,form:80,form_prefill:70,url:60,dataLayer:50,customDataLayer:50,metatag:30},_mergeCapture(e,t){for(const[n,a]of Object.entries(t)){if(!a)continue;const r=this._capturedData[n],o=r?this._sourcePriority[r.source]||0:-1,c=this._sourcePriority[e]||0;(!r||c>=o)&&(this._capturedData[n]={value:a,source:e})}},getCapturedData(){const e={};for(const[t,n]of Object.entries(this._capturedData))e[t]=n.value;return e},async buildUserData(e={}){const t={...this.getCapturedData()},n={em:"_mt_em",ph:"_mt_ph",external_id:"_mt_eid",fn:"_mt_fn",ln:"_mt_ln",ct:"_mt_ct",st:"_mt_st",zp:"_mt_zp",country:"_mt_country"};for(const[o,c]of Object.entries(n))if(!t[o]&&c){const s=p(c);s&&(t[o]=s)}const a={email:"em",phone:"ph",first_name:"fn",last_name:"ln",gender:"ge",date_of_birth:"db",city:"ct",state:"st",zip:"zp",zipcode:"zp",postal_code:"zp"};for(const[o,c]of Object.entries(e)){const s=a[o]||o;c&&(t[s]=c)}const r=await this.normalizeAndHash(t);if(r.fbp=r.fbp||_.getFbp()||void 0,r.fbc=r.fbc||_.getFbc()||void 0,r.client_user_agent=r.client_user_agent||navigator.userAgent,!r.external_id){const o=_.getVisitorId();o&&(r.external_id=await K(o)??void 0)}return r},scoreMatchQuality(e){let t=0;const n={em:30,ph:25,external_id:15,fn:5,ln:5,ct:3,st:2,zp:3,country:2,ge:2,db:3,fbp:5,fbc:10,client_ip_address:3,client_user_agent:2};for(const[a,r]of Object.entries(n))e[a]&&(t+=r);return Math.min(t,100)},getDiagnostics(){const e={};for(const[t,n]of Object.entries(this._capturedData))e[t]={source:n.source,hasValue:!0,isHashed:z(n.value)};return{capturedFields:Object.keys(this._capturedData).length,fields:e,storedIdentity:{em:!!p("_mt_em"),ph:!!p("_mt_ph"),fn:!!p("_mt_fn"),ln:!!p("_mt_ln"),external_id:!!p("_mt_eid")}}}},_={init(){i.cookieKeeper.enabled&&(this.restoreCookies(),this.captureFbclid(),this.ensureFbp(),this.ensureVisitorId(),this.syncToServer(),this.scheduleRefresh(),d("CookieKeeper: ready",{fbp:this.getFbp(),fbc:this.getFbc()}))},restoreCookies(){const e=i.cookieKeeper.cookieNames||[];for(const t of e)if(F(t))try{localStorage.setItem("mt_"+t,F(t))}catch{}else try{const n=localStorage.getItem("mt_"+t);n&&L(t,n,i.cookieKeeper.maxAge)}catch{}},captureFbclid(){try{const e=new URL(l.location.href).searchParams.get("fbclid");if(e){const t=`fb.1.${Math.floor(Date.now()/1e3)}.${e}`;k("_fbc",t,i.cookieKeeper.maxAge)}}catch{}},ensureFbp(){if(!p("_fbp")){const e=`fb.1.${Date.now()}.${Math.floor(Math.random()*2147483647)}`;k("_fbp",e,i.cookieKeeper.maxAge)}},ensureVisitorId(){p("_mt_id")||V()},async syncToServer(){const e={_fbp:p("_fbp"),_fbc:p("_fbc"),_mt_id:p("_mt_id"),_mt_em:p("_mt_em"),_mt_ph:p("_mt_ph")};if(!e._fbp&&!e._fbc&&!e._mt_id)return;const t=p("_mt_cookie_sync");if(!(t&&Date.now()-parseInt(t,10)<i.cookieKeeper.refreshInterval))try{await R(D("/cookie-sync"),{cookies:e,domain:l.location.hostname,max_age:i.cookieKeeper.maxAge}),k("_mt_cookie_sync",Date.now().toString(),1)}catch(n){h("CookieKeeper: sync failed",n.message)}},refreshCookies(){const e=i.cookieKeeper.maxAge;for(const t of i.cookieKeeper.cookieNames||[]){const n=p(t);n&&L(t,n,e)}k("_mt_cookie_sync","0",1),this.syncToServer()},scheduleRefresh(){A&&clearInterval(A),A=setInterval(()=>this.refreshCookies(),i.cookieKeeper.refreshInterval),u.addEventListener("visibilitychange",()=>{u.visibilityState==="visible"&&this.restoreCookies()})},getFbp(){return p("_fbp")},getFbc(){return p("_fbc")},getVisitorId(){return p("_mt_id")}},y={async detect(){if(!i.adBlockRecovery.enabled)return!1;try{const e=i.endpoint.replace(/\/track\/?$/,"")+"/health",t=new AbortController,n=setTimeout(()=>t.abort(),3e3),a=await fetch(e,{method:"GET",signal:t.signal,cache:"no-store"});if(clearTimeout(n),!a.ok)throw new Error("Blocked");return!1}catch{return g=!0,d("AdBlockRecovery: DETECTED"),!0}},getEndpoint(e){return g&&i.adBlockRecovery.proxyPath?i.endpoint.replace(/\/api\/v1\/track\/?$/,"")+i.adBlockRecovery.proxyPath+e:i.endpoint+e},getFallbackEndpoints(e){const t=[this.getEndpoint(e)];if(i.adBlockRecovery.customEndpoints)for(const n of i.adBlockRecovery.customEndpoints)t.push(n+e);return t},disguisePayload(e){return{d:btoa(JSON.stringify(e)),t:Date.now(),v:T}},getHeaders(){const e={"Content-Type":"application/json"};return e[g?"X-Request-Token":"X-API-Key"]=i.apiKey,e}},O={resolve(e){if(e=e||l.location.hostname,!i.pixels||i.pixels.length===0)return i.pixelId?[i.pixelId]:[];const t=[];let n=null;for(const a of i.pixels)if(!(!a.pixelId||!a.domains))for(const r of a.domains){if(r==="*"){n=a.pixelId;continue}if(this.matchDomain(e,r)){t.push(a.pixelId);break}}return t.length===0&&n&&t.push(n),[...new Set(t)]},matchDomain(e,t){if(e===t)return!0;if(t.startsWith("*.")){const n=t.substring(2);return e.endsWith("."+n)||e===n}return e.endsWith("."+t)},getAllPixelIds(){return!i.pixels||i.pixels.length===0?i.pixelId?[i.pixelId]:[]:[...new Set(i.pixels.map(e=>e.pixelId).filter(Boolean))]}};function D(e){return g?y.getEndpoint(e):i.endpoint+e}async function w(e,t){const n=y.getHeaders(),a=g?y.disguisePayload(t):t,r=await fetch(e,{method:"POST",headers:n,body:JSON.stringify(a),keepalive:!0,credentials:"include"});if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json().catch(()=>({}))}function W(e,t){const n=g?y.disguisePayload(t):t,a=new Blob([JSON.stringify(n)],{type:"application/json"});if(!navigator.sendBeacon(e+"?api_key="+encodeURIComponent(i.apiKey),a))throw new Error("Beacon failed");return Promise.resolve({sent:!0})}function Q(e,t){return new Promise((n,a)=>{const r=new XMLHttpRequest;r.open("POST",e,!0);const o=y.getHeaders();for(const[c,s]of Object.entries(o))r.setRequestHeader(c,s);r.withCredentials=!0,r.timeout=1e4,r.onload=()=>r.status>=200&&r.status<300?n(JSON.parse(r.responseText||"{}")):a(new Error(`XHR ${r.status}`)),r.onerror=()=>a(new Error("XHR error")),r.ontimeout=()=>a(new Error("XHR timeout")),r.send(JSON.stringify(g?y.disguisePayload(t):t))})}function X(e,t){return new Promise((n,a)=>{const r=btoa(JSON.stringify(t)),o=new URLSearchParams({d:r,k:i.apiKey,t:Date.now().toString()}),c=e.replace(/\/(event|batch)$/,"/pixel.gif")+"?"+o;if(c.length>4e3){a(new Error("Payload too large"));return}const s=new Image(1,1);s.onload=()=>n({sent:!0}),s.onerror=()=>a(new Error("Image pixel failed")),s.src=c})}async function R(e,t,n=0){const a=[{name:"fetch",fn:w},{name:"beacon",fn:W,skip:!i.adBlockRecovery.useBeacon},{name:"xhr",fn:Q},{name:"img",fn:X,skip:!i.adBlockRecovery.useImage}].filter(r=>!r.skip);for(const r of a){const o=e.includes(i.endpoint)?e.replace(i.endpoint,""):e.replace(/^https?:\/\/[^\/]+/,"").replace(/.*\/api\/v1\/track/,""),c=g?y.getFallbackEndpoints(o):[e];for(const s of c)try{const f=await r.fn(s,t);return r.name!==M&&(d(`Transport: ${M} → ${r.name}`),M=r.name),f}catch(f){d(`${r.name} → ${s}: ${f.message}`)}}if(n<N.length)return new Promise(r=>setTimeout(()=>r(R(e,t,n+1)),N[n]));h("All transports exhausted")}async function J(e){if(!e.length)return;const t=e.length===1?D("/event"):D("/batch"),n=e.length===1?e[0]:{events:e};try{await R(t,n)}catch(a){h("Send failed:",a)}}function P(){I.length&&J(I.splice(0,50))}function Y(e){I.push(e),i.batchEvents?(S&&clearTimeout(S),S=setTimeout(P,q)):P()}const B={_loaded:!1,init(){if(!i.browserPixel.enabled||this._loaded)return;if(typeof l.fbq=="function"){d("BrowserPixel: fbq already present, initializing pixels"),this._initPixels(),this._loaded=!0;return}d("BrowserPixel: loading fbevents.js");const e=l.fbq=function(){e.callMethod?e.callMethod.apply(e,arguments):e.queue.push(arguments)};l._fbq||(l._fbq=e),e.push=e,e.loaded=!0,e.version="2.0",e.queue=[];const t=u.createElement("script");t.async=!0,t.src="https://connect.facebook.net/en_US/fbevents.js";const n=u.getElementsByTagName("script")[0];if(n&&n.parentNode)n.parentNode.insertBefore(t,n);else{const a=()=>{const r=u.getElementsByTagName("script")[0];r&&r.parentNode?r.parentNode.insertBefore(t,r):u.head.appendChild(t)};u.body?a():u.addEventListener("DOMContentLoaded",a)}this._initPixels(),this._loaded=!0},_initPixels(){const e=O.getAllPixelIds();if(!e.length){h("BrowserPixel: no pixel IDs configured");return}for(const t of e)l.fbq("init",t),d("BrowserPixel: init pixel",t);i.browserPixel.autoPageView&&(l.fbq("track","PageView"),d("BrowserPixel: PageView fired"))},trackEvent(e,t,n={},a=null){if(!i.browserPixel.enabled||!i.browserPixel.syncEvents||typeof l.fbq!="function")return;const o=["PageView","ViewContent","AddToCart","AddPaymentInfo","AddToWishlist","CompleteRegistration","Contact","CustomizeProduct","Donate","FindLocation","InitiateCheckout","Lead","Purchase","Schedule","Search","StartTrial","SubmitApplication","Subscribe"].includes(e),c={...n},s={eventID:t};o?l.fbq("track",e,c,s):l.fbq("trackCustom",e,c,s),d("BrowserPixel: synced",e,"eventID:",t)}},C=[];let b=null;const E={init(){if(!i.consent.enabled){b=!0;return}b=i.consent.mode==="opt-out"?i.consent.defaultConsent??!0:i.consent.defaultConsent??!1,d("ConsentManager: mode="+i.consent.mode,"default="+b),this._detectCMP()},_detectCMP(){if(typeof l.OneTrust<"u"||typeof l.OptanonWrapper<"u"){this._initOneTrust();return}if(typeof l.Cookiebot<"u"){this._initCookiebot();return}if(typeof l.truste<"u"){this._initTrustArc();return}if(typeof l.Osano<"u"){this._initOsano();return}if(typeof l.gtag=="function"){this._initGoogleConsentMode();return}if(typeof l.__tcfapi=="function"){this._initTCF();return}if(d("ConsentManager: no CMP detected, using default consent="+b),i.consent.waitForConsent){const e=()=>{if(typeof l.OneTrust<"u"){this._initOneTrust();return}if(typeof l.Cookiebot<"u"){this._initCookiebot();return}if(typeof l.truste<"u"){this._initTrustArc();return}if(typeof l.Osano<"u"){this._initOsano();return}if(typeof l.__tcfapi=="function"){this._initTCF();return}d("ConsentManager: no CMP after DOM ready")};u.readyState==="loading"?u.addEventListener("DOMContentLoaded",e):setTimeout(e,1e3)}},_initOneTrust(){d("ConsentManager: OneTrust detected");const e=i.consent.consentCategory,t=()=>{const a=l.OnetrustActiveGroups||"";this._updateConsent(a.includes(e),"OneTrust")},n=l.OptanonWrapper;l.OptanonWrapper=function(){typeof n=="function"&&n(),t()},l.OnetrustActiveGroups&&t()},_initCookiebot(){d("ConsentManager: Cookiebot detected");const e=()=>{const t=l.Cookiebot;t&&this._updateConsent(t.consent?.marketing===!0,"Cookiebot")};l.addEventListener("CookiebotOnAccept",e),l.addEventListener("CookiebotOnDecline",e),l.Cookiebot?.consented&&e()},_initTrustArc(){d("ConsentManager: TrustArc detected");const e=()=>{try{const t=l.truste?.eu?.bindMap?.prefCookie;this._updateConsent(t!==void 0?parseInt(t,10)>=3:!1,"TrustArc")}catch{}};l.addEventListener("message",t=>{typeof t.data=="string"&&t.data.includes("truste.eu.cookie")&&setTimeout(e,100)}),e()},_initOsano(){d("ConsentManager: Osano detected");const e=l.Osano;if(typeof e?.cm?.addEventListener=="function"&&e.cm.addEventListener("osano-cm-consent-saved",t=>{this._updateConsent(t.MARKETING==="ACCEPT","Osano")}),typeof e?.cm?.getConsent=="function"){const t=e.cm.getConsent();t.MARKETING&&this._updateConsent(t.MARKETING==="ACCEPT","Osano")}},_initGoogleConsentMode(){d("ConsentManager: Google Consent Mode detected");const e=l.dataLayer||[],t=e.push.bind(e);e.push=(...n)=>{const a=t(...n);for(const r of n)if(r&&typeof r=="object"&&r[0]==="consent"&&r[1]==="update"){const o=r[2];o?.ad_storage&&this._updateConsent(o.ad_storage==="granted","GoogleConsentMode")}return a};try{const n=l.google_tag_data?.ics?.entries;n?.ad_storage&&this._updateConsent(n.ad_storage.value==="granted","GoogleConsentMode")}catch{}},_initTCF(){d("ConsentManager: IAB TCF v2 detected");const e=()=>{l.__tcfapi("getTCData",2,(t,n)=>{if(!n||!t)return;if(!t.gdprApplies){this._updateConsent(!0,"TCF");return}const a=t.purpose?.consents??{};this._updateConsent(a[1]===!0&&a[4]===!0,"TCF")})};l.__tcfapi("addEventListener",2,(t,n)=>{n&&e()}),e()},_updateConsent(e,t){const n=b;b=e,n!==e&&d("ConsentManager: consent "+(e?"GRANTED":"REVOKED")+" via "+t),e&&C.length&&this._flushPending()},_flushPending(){for(d("ConsentManager: flushing",C.length,"queued calls");C.length;){const e=C.shift(),t=v[e.method];typeof t=="function"&&t.apply(v,e.args)}},hasConsent(){return i.consent.enabled?b===!0:!0},grantConsent(){this._updateConsent(!0,"manual")},revokeConsent(){this._updateConsent(!1,"manual")},queueIfNeeded(e,t){return!i.consent.enabled||b===!0?!1:i.consent.waitForConsent?(C.push({method:e,args:t}),d("ConsentManager: queued",e,"("+C.length+" pending)"),!0):(h("ConsentManager: blocked",e,"(no consent)"),!0)}},v={VERSION:T,async init(e){return x?(h("Already initialized"),this):!e.endpoint||!e.apiKey?(h("Missing: endpoint, apiKey"),this):!("pixelId"in e&&e.pixelId)&&!("pixels"in e&&e.pixels?.length)?(h("Missing: pixelId or pixels[]"),this):e.respectDnt&&(navigator.doNotTrack==="1"||l.doNotTrack==="1")?this:(i={...i,...e,browserPixel:{...i.browserPixel,...e.browserPixel||{}},consent:{...i.consent,...e.consent||{}},cookieKeeper:{...i.cookieKeeper,...e.cookieKeeper||{}},adBlockRecovery:{...i.adBlockRecovery,...e.adBlockRecovery||{}},advancedMatching:{...i.advancedMatching,...e.advancedMatching||{}}},x=!0,d("Initialized v"+T),E.init(),B.init(),_.init(),m.init(),i.adBlockRecovery.enabled&&y.detect().then(t=>{t&&d("Ad blocker recovery: ACTIVE")}),i.autoPageView&&this.trackPageView(),l.addEventListener("visibilitychange",()=>{u.visibilityState==="hidden"&&P()}),l.addEventListener("beforeunload",P),this)},async track(e,t={},n={},a={}){if(!x){h("Not initialized");return}if(E.queueIfNeeded("track",[e,t,n,a]))return;const r=a.event_id||U(),o=i.advancedMatching.enabled?await m.buildUserData(n):await m.normalizeAndHash(n),c=m.scoreMatchQuality(o);d(`Match quality: ${c}/100`);const s=a.pixel_id?[a.pixel_id]:O.resolve();if(!s.length){h("No pixel for:",l.location.hostname);return}for(const f of s){const j={pixel_id:f,event_name:e,event_id:s.length>1?`${r}_${f.slice(-4)}`:r,event_time:Math.floor(Date.now()/1e3),event_source_url:l.location.href,action_source:a.action_source||"website",user_data:{...o},match_quality:c,visitor_id:_.getVisitorId()||null};Object.keys(t).length>0&&(j.custom_data=t),d("Track:",e,"→",f,`(match: ${c})`),Y(j),B.trackEvent(e,j.event_id,t,f)}return r},trackPageView(e={}){return this.track("PageView",{},e)},trackViewContent(e={},t={}){return this.track("ViewContent",e,t)},trackAddToCart(e={},t={}){return this.track("AddToCart",e,t)},trackPurchase(e={},t={}){return this.track("Purchase",e,t)},trackLead(e={},t={}){return this.track("Lead",e,t)},trackCompleteRegistration(e={},t={}){return this.track("CompleteRegistration",e,t)},trackInitiateCheckout(e={},t={}){return this.track("InitiateCheckout",e,t)},trackSearch(e={},t={}){return this.track("Search",e,t)},trackToPixel(e,t,n={},a={}){return this.track(t,n,a,{pixel_id:e})},async identify(e={}){if(!x){h("Not initialized");return}const t={email:"em",phone:"ph",first_name:"fn",last_name:"ln",gender:"ge",date_of_birth:"db",city:"ct",state:"st",zip:"zp",zipcode:"zp",postal_code:"zp"},n={};for(const[o,c]of Object.entries(e)){if(!c)continue;const s=t[o]||o;n[s]=c}const a=await m.normalizeAndHash(n),r={em:"_mt_em",ph:"_mt_ph",fn:"_mt_fn",ln:"_mt_ln",external_id:"_mt_eid",ct:"_mt_ct",st:"_mt_st",zp:"_mt_zp",country:"_mt_country"};for(const[o,c]of Object.entries(r)){const s=a[o];s&&c&&k(c,s,i.cookieKeeper.maxAge)}m._mergeCapture("identify",n),d("Identify:",Object.keys(a).filter(o=>a[o]&&!["client_user_agent","fbp","fbc"].includes(o))),_.syncToServer()},clearIdentity(){["_mt_em","_mt_ph","_mt_fn","_mt_ln","_mt_eid","_mt_ct","_mt_st","_mt_zp","_mt_country"].forEach(t=>G(t)),m._capturedData={},d("Identity cleared")},addPixel(e,t){i.pixels.push({pixelId:e,domains:Array.isArray(t)?t:[t]})},removePixel(e){i.pixels=i.pixels.filter(t=>t.pixelId!==e)},refreshCookies(){_.refreshCookies()},hasConsent(){return E.hasConsent()},grantConsent(){E.grantConsent()},revokeConsent(){E.revokeConsent()},flush(){P()},isAdBlocked(){return g},getTransport(){return M},getDebugInfo(){return{version:T,initialized:x,transport:M,adBlockDetected:g,config:{endpoint:i.endpoint,pixelId:i.pixelId,pixelCount:i.pixels.length},cookies:{fbp:_.getFbp(),fbc:_.getFbc(),visitorId:_.getVisitorId()},routing:{domain:l.location.hostname,active:O.resolve(),all:O.getAllPixelIds()},advancedMatching:m.getDiagnostics(),queueSize:I.length}},async getMatchQuality(e={}){const t=i.advancedMatching.enabled?await m.buildUserData(e):await m.normalizeAndHash(e);return{score:m.scoreMatchQuality(t),fields:Object.keys(t).filter(n=>t[n])}},addUserData(e,t="explicit"){m._mergeCapture(t,e)}};l.MetaTracker=v,l.MetaTrackerQueue&&Array.isArray(l.MetaTrackerQueue)&&l.MetaTrackerQueue.forEach(([e,...t])=>{const n=v[e];typeof n=="function"&&n.apply(v,t)})})(window,document);
